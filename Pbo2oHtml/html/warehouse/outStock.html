<!DOCTYPE HTML>
<html>
<head>
<TITLE>出库单</TITLE>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<link rel="stylesheet" type="text/css" href="../../themes/default/easyui.css">
<link rel="stylesheet" type="text/css" href="../../themes/icon.css">
<link rel="stylesheet" type="text/css" href="../../themes/demo.css">
<link rel="stylesheet" type="text/css" href="../../css/timeline.css">
<script type="text/javascript" src="../../js/jquery.min.js"></script>
<script type="text/javascript" src="../../js/jquery.easyui.min.js"></script>
<script type="text/javascript" src="../../js/locale/easyui-lang-zh_CN.js"></script>
<script type="text/javascript" src="../../js/ajaxfileupload.js"></script>
<script type="text/javascript" src="../../js/timeline.js"></script>
<script type="text/javascript" src="../global.js"></script>
<style type="text/css">
		.report-title {
		    color: #00A8BD;
		    font: bold 34px "黑体";
		    margin: 0.5em 0;
		    text-align: center;
		}
		#outWsOwner .textbox{
			width:500px !important;
		}
		#outOrder3 .textbox{
			width: 104px !important;
		}
		#quoutStock .textbox{
			width: 135px !important;
		}
</style>
<script type="text/javascript">
	var url;
	var hig=0;
	function domark(er,index){
    	$('#mark').dialog('open');
    	var markId = $("input[type=radio][name=markId]");
    	for (var i = 0; i < markId.length; i++) {
			if (markId[i].value == er) {
				markId[i].checked = true;
			}else {
				markId[i].checked = false;
			}
		}
		var outStockNoMk = $('#dg').datagrid("getRows")[index].outStockNo;
		var orderMemo = $('#dg').datagrid("getRows")[index].orderMemo;
		$("input[name='outStockNoMk").val(outStockNoMk);
		$("textarea[name='orderMemo']").val(orderMemo);
	}
	$(function () {			
		$('#queryStatus').combobox({
			url:'instock/getCongfigStatus?configType=outStockState',
	 		valueField:'configId',
	 		textField:'configName',
	 		width:'140',
	 		panelHeight: '100',
	 		editable:false,
	        value:'--请选择--' 
	    });
		$('#wareHouse').window({
	    	title: '仓库信息',
	    	width:700,
	    	height:239,
	    	closed:true
		});
		$('#delivery').dialog({
	    	title: '送货单信息',
	    	width:950,
	    	height:250,
	    	closed:true
		});
		$('#province').combobox({
		 	valueField:'provinceId', //值字段
	        textField:'provinceName', //显示的字段
	        url:'areaController/getAllProvince',
	        editable:false,//不可编辑，只能选择
	        width:'100',
	        value:'--请选择--',
	        onSelect:function(){
	        	var province = $(this).combobox('getValue');
	            $('#city').combobox({
	            	 valueField:'cityId', 
	                 textField:'cityName',
	                 url:'areaController/getCityByProvinceId?provinceId='+province,
		             required:true,
		             editable:false,//不可编辑，只能选择
		             value:'--请选择--' 
	          }); 
	        },
		});
		$('#city').combobox({
	        editable:false,
	        width:'100',
	        value:'请先选择省份',
	       	onSelect:function(){
	        	var city = $(this).combobox('getValue');
	            $('#area').combobox({
	            	valueField:'areaId', 
	                textField:'areaName',
	                url:'areaController/getAreaByCityId?cityId='+city,
		            required:true,
		            editable:false,//不可编辑，只能选择
		            value:'--请选择--'
	           });
	       	},
	     	onLoadSuccess:function(){
	       		$('#area').combobox({
			 		width:'100',
			 		editable:false,
	       			value:'请先选择城市',
	       			
				});
	    	}
	    });
		$('#area').combobox({
	 		width:'100',
	 		editable:false,
	 		value:'请先选择城市'
		});
		$('#start').datebox({    
			    width:'130px',
			    onSelect:function(start){
			    	var now = new Date();
			    	if(start > now){
			    		$.messager.alert('提示','操作失败!日期不能超过当前时间','error');
			    		$('#start').datebox('setValue','');
			    	}
			    	
		 		}
		});
		$('#end').datebox({    
		    width:'130px',
		    onSelect:function(date){
		    	var start = $('#start').datebox('getValue');
		    	var end = $('#end').datebox('getValue');
		    	if(start>end){
		    		$.messager.alert('提示','操作失败!起始时间不能晚于结束时间','error');
		    		$('#end').datebox('setValue','');
		    	}
	 		}
		});
		$('#mark').window({
        	title: '修改标识',
        	width:600,
        	height:405,
        	resizable:false, 
        	closed:true,
            minimizable: false,
            maximizable: false,
            collapsible: false
   		});
		$('#salesCategory').combobox({  
			editable:false,
			readonly:false,
		    url:'salesList/getSalesCategory',  
		    valueField:'catId',    
		    textField:'catName',
		    value:'--请选择品类--' 
		}); 
	    $('#add').dialog({
	    	title: '添加出库单',
	    	width:'700',
	    	height:'600',
	       	closed:true,
	       	resizable:false, 
	        minimizable: false,
	        maximizable: false,
	        collapsible: false,
	        maximized:true,
	        onOpen:function(){
				$.ajax({
			        url: 'outstock/getToken',
			        type: "post",
			        success: function (text) {
			        	$('#outStockToken').val(text.outStockToken);
			        },
			        error: function (jqXHR, textStatus, errorThrown) {
			        	$.messager.show({
							title: 'Error',
							msg: jqXHR.responseText
						});
			        }
			    });
	        },
			/* onBeforeClose:function(){
				$('#dg').datagrid('reload');
			}, */
	       /*  onClose: function () {  
	        	$('#form1').form('clear');
	         	$('#itemsdg').datagrid('loadData', { total: 0, rows: [] });
	            $('#itemsdg1').datagrid('loadData', { total: 0, rows: [] }); 
	            $('#delivery').dialog('close');
	      		$('#wareHouse').window('close');
	        } */
	   	});	    
	    $('#selectLotNo').dialog({
	    	title: '按批次出库',
	    	width:'950',
	    	height:'600',
	       	closed:true,
	       	resizable:true, 
	        minimizable: false,
	        maximizable: false,
	        collapsible: false,
	        //maximized:true,
	        onClose: function () {  
	        	$('#stockTotalInfo').datagrid('loadData', { total: 0, rows: [] });
		      	$('#stockTotalDetilInfo').datagrid('loadData', { total: 0, rows: [] }); 
	        }
	   	});
	    
		var toolbar = [];
		if(verification("outstock","add")){
			toolbar.push({
				id: 'btnadd',
                text: '新增出库单 ',
                iconCls: 'icon-add',
                handler: function () {
                	$('#itemsdgDiv').hide();
                	addOutStock();
                }
			});
		}
	    var tableH = Math.max(document.documentElement.scrollHeight,document.body.scrollHeight)-($('#dg').offset().top+10);
		$('#dg').datagrid({
			iconCls: 'icon-save',
	        width: "100%",
	        height: tableH,
            nowrap: true,
        	autoRowHeight: true,
        	singleSelect: true,
        	multiSort : true,
        	striped: true,
        	resizable : true, 
        	collapsible: true,
        	rownumbers:true,
        	checkOnSelect: true,
	        url: 'outstock/getAllOutStockInfo',
	        queryParams: {
	        	queryWarehouseNo : 'isEmpt',
	        	queryOutStockNo : 'isEmpt',
	        	queryDeliveryNo : 'isEmpt',
	        	queryStatus:'isEmpt',
	        	areaId : 'isEmpt',
	    		start : '',
	    		end : ''
			},
	        idField: 'outStockNo',
	        columns: [[	           
	        	{ field: 'markId', title: '标识',
	            	formatter:function(value, row, index){
						return '<img onclick="javascript:domark('+value+','+index+');" src="../../images/'+value+'.png">';
				}},
	        	{ field: 'outStockNo', title: '出库单编号',width:150,align:'center'},
	            { field: 'warehouseNo', title: '仓库编号',width:100,align:'center'},
	            { field: 'warehouseName', title: '仓库名',width:120,align:'center'},
	            { field: 'wareEmploye', title: '仓库负责人',width:100,align:'center'},
	            { field: 'deliveryNo', title: '送货单号',width:150,align:'center'},
	            { field: 'outStockDate', title: '出库时间',width:150,align:'center'},
	            { field: 'status', title: '状态',width:60,align:'center'},
	            { field: 'type', title: '类型',width:100,align:'center'},
	            { field: 'totalWeight', title: '总重量(KG)',width:100,align:'center'},
	            { field: 'totalWeighing', title: '过磅重量(KG)',width:100,align:'center'},
	            { field: 'preOutWeight',title:'预计出库重量(KG)',width:100,align:'center'},
	            { field: 'totalQuanlity', title: '总数量',width:100,align:'center'},
	            { field: 'totalCost', title: '总成本(元)',width:100,align:'center'},
	            { field: 'createTime', title: '创建时间',width:180,align:'center'},
	            { field: 'createName', title: '创建人',width:100,align:'center'},
	            { field: 'updateTime', title: '修改时间',width:180, hidden:true},
	            { field: 'updateName', title: '修改人',width:100, hidden:true}
	    /*        <%--  { field: 'operational', title: '操作',width:100, 
	            	formatter: function (value, row, index) {
	         			return (<%=((Map<String, Map<String,String>>)session.getAttribute("rolBtn")).get("outstock").containsKey("searchDetile")%>?
	         					"<a href=\"javascript:editRow('"+row.outStockNo+"');\">查看</a>":"");
	                 }
	         	}, --%> */
	            		 
	        ]],
	        onLoadSuccess:function(){
	        	  $(this).datagrid('clearChecked');
	       	},
	        onDblClickRow:function(index,row){ 
				editRow(row.outStockNo);
        	},
	        pagination: true,
        	pageSize : 40, 
        	pageList : [40, 80, 120],
	        toolbar:toolbar
	    });
		$('#itemsdgShow').datagrid({
			title: '按批次显示',
	        width: "100%",
	    	height: 300,
	        nowrap: true,
	        autoRowHeight: false,
	        striped: true,
	        collapsible: true,
	    	singleSelect:true,
	        remoteSort: false,
	        checkOnSelect: true,
	        url: '',
	        columns: [[
	              {field:'lotNo',title:'批次号',width:170,align:'center'},
	        	  {field:'boxCode',title:'箱号',width:110,align:'center'},
	        	  {field:'owner',title:'货主',width:80,align:'center'},
	              {field:'configName',title:'商品类型',width:140,align:'center'},
	              {field:'totalQuanlity',title:'总数量',width:80,align:'center'},
	              {field:'totalWeight',title:'总重量(kg)',width:80,align:'center'},
	              {field:'totalCost',title:'总成本价格(元)',width:100,align:'center'}
	        ]],
	        pagination: false
	    }); 
		$('#itemsdg').datagrid({
	        title:'按详情显示',
	        width: "100%",
	    	height: 300,
	    	fitColumns:true,
	        nowrap: true,
	        autoRowHeight: false,
	        striped: true,
	        collapsible: true,
	    	singleSelect:true,
	        remoteSort: false,
	        rownumbers:true,
	        checkOnSelect: true,
	        url: '',
	        columns: [[
	        	  {field:'productId',title:'商品ID',hidden:true},
	              {field:'configName',title:'商品类型',align:'center'},
	              {field:'brandName',title:'品牌',align:'center'},
	              {field:'modelName',title:'型号',align:'center'},
	              {field:'companyName',title:'货主',align:'center'},
	              {field:'quanlity',title:'数量',align:'center'},
	              {field:'unit',title:'单位',align:'center'},
	              {field:'commWeight',title:'单位重量',align:'center'},
	              {field:'weight',title:'重量(KG)',align:'center'},
	              {field:'cost',title:'成本价格(元)',align:'center'},
	              {field:'lotNo',title:'批次号',align:'center'},
	        ]],
	        pagination: false,
	    });
		$('#itemsdg1').datagrid({
		    title: '按商品显示',
	        width: "100%", 
	    	height: 300,
	    	fitColumns:true,
	        nowrap: true,
	        autoRowHeight: false,
	        striped: true,
	        collapsible: true,
	    	singleSelect:true,
	        remoteSort: false,
	        rownumbers:true,
	        checkOnSelect: true,
			url: '',
	        columns: [[
	              {field:'configName',title:'商品类型',align:'center',width:80},
	              {field:'brandName',title:'品牌',align:'center',width:80},
	              {field:'modelName',title:'型号',align:'center',width:80},
		          {field:'totQuanlity',title:'总数量',align:'center',width:80},
		          {field:'unit',title:'单位',align:'center',width:80},
		          {field:'commWeight',title:'单位重量',align:'center',width:80},
		          {field:'totWeight',title:'总重量(KG)',align:'center',width:80},
		          {field:'totCost',title:'总成本(元)',align:'center',width:80},
	        ]],
	        pagination: false,
	   }); 
	});	
	
function addOutStock(){
	var delRole = verification("outstock","delete");
	var addRole = verification("outstock","add");
	var updateRole =verification("outstock","update");
	var datas=[
        {
            time:"",//对应的时间
            text:"待制单",//对应的文字内容
            state:0//当前状态，配1为亮色，0为暗色
        },{
            time:"",
            text:"已制单",
            state:1
        },{
            time:"",
            text:"已出库",
            state:0
        },{
            time:"",
            text:"已作废",
            state:0 
        }];
    var conf={
    	      textAlign:'left',//设置文字位置,left在点上方,center在线上方
    	      lineWidth:200//设置线条长度
    	    };
    $(function(){
    	$(".pro").empty().timeLines(datas,conf);
    });
	$('#add').dialog({
    	title: '添加出库单'
   	});
 	$('#salesCategory').combo('enable');
 	$("#salesCategory").combobox('setValue','--请选择品类--');
	//$('#btn1').linkbutton('enable');
	$('#allOutStock').linkbutton('enable');
	$('#allOutStock').show();
	$('#outStockByDeliveryNo').linkbutton('enable');
	$('#outStockByDeliveryNo').show();
	//$('#delBtn').linkbutton('disable');
	//$('#btn2').linkbutton('disable');
	$('#outStockNo').textbox('textbox').css('background','#EBEBE4');
	$('#outStockNo').textbox('textbox').css('background','#EBEBE4');
	$('#createUser').textbox('textbox').css('background','#EBEBE4');
	$('#outStockState').textbox('textbox').css('background','#EBEBE4');
	$('#totalWeight').textbox('textbox').css('background','#EBEBE4');
	$('#totalQuanlity').textbox('textbox').css('background','#EBEBE4');
	$('#Cost').textbox('textbox').css('background','#EBEBE4');
	$("#totalWeighing").textbox({readonly:true,prompt:"请先选择出库方式"});
	$('#outStockDate').datebox({    
		required:true,
	    editable:true,
	    onSelect:function(start){
	    	var now = new Date();
	    	if(start > now){
	    		$.messager.alert('提示','操作失败!日期不能超过当前时间','error');
	    		$('#outStockDate').datebox('setValue','');
	    	}
 		}
	});
	var outStockDate=getNowFormatDate();
	$('#outStockDate').datebox('setValue',outStockDate);
	$('#outStockState').textbox('setValue','已制单');
	$.ajax({
        url: 'instock/getCreateUser',
        type: "post",
        success: function (text) {
        	$('#createUser').textbox('setValue',text.contact);
        },
        error: function (jqXHR, textStatus, errorThrown) {
        	$.messager.alert('提示','操作失败','error');
        }
	});
	$("#add").dialog('open').dialog('refresh'); 
	//按钮控制
	$('#btn2').linkbutton('disable');
	$('#btn2').hide();
	$('#delBtn').linkbutton('disable');
	$('#delBtn').hide();
	if (addRole == false) {
		$('#btn2').linkbutton('disable');
    	$('#btn1').hide();
	}else{
		$('#btn1').show();
		$('#btn1').linkbutton('enable');
	}
}

function getNowFormatDate() {
    var date = new Date();
    var seperator1 = "-";
    var seperator2 = ":";
    var month = date.getMonth() + 1;
    var strDate = date.getDate();
    if (month >= 1 && month <= 9) {
        month = "0" + month;
    }
    if (strDate >= 0 && strDate <= 9) {
        strDate = "0" + strDate;
    }
    var currentdate = date.getFullYear() + seperator1 + month + seperator1 + strDate
    return currentdate;
}
function addOutStockSubmit(stateId){
	var salesCategory=$('#salesCategory').combobox('getValue');
	var outStockToken=$('#outStockToken').val();
	var warehouseNo1=$('#warehouseNo1').val();
	var deliveryNo=$('#deliveryNo').textbox("getValue");
	var outStockDate=$('#outStockDate').datebox("getValue");
	var totalWeighing=$('#totalWeighing').textbox("getValue");
	if(outStockDate==null || outStockDate==""){
		$.messager.alert('提示','操作失败!请选择出库时间','error');
		return;
	}
	if(warehouseNo1==null || warehouseNo1==""){
		$.messager.alert('提示','操作失败!请选择仓库','error');
		return;
	}
	if(deliveryNo==null || deliveryNo==""){
		$.messager.alert('提示','操作失败!请选择送货单号','error');
		return;
	}
	if(totalWeighing==null || totalWeighing==""){
		$.messager.alert('提示','操作失败!请填写过磅重量','error');
		return;
	}
	var json1=getJsonDate();
	var totalWeighing = $("#totalWeighing").textbox('getValue');
	var deliveryNo = $('#deliveryNo').textbox('getValue');
	var a;
	$.ajax({
		async: false,
		url: 'outstock/valiTotalWeing',
        type: "post",
        data:{
        	totalWeighing:totalWeighing,
        	deliveryNo:deliveryNo
        },
        success: function (text) {
        	if(text.error!=null && text.error=='N'){
        		$.messager.alert('提示',text.errorMsg,'error');
        		a=1;
        	}else {
				a = 2;
			}
        },
        error: function (jqXHR, textStatus, errorThrown) {
        	a = 2;
        	$.messager.show({
				title: 'Error',
				msg: jqXHR.responseText
			});
        }
    });

	if(a == 1){
			return;
		}
	var formData = new FormData(document.getElementById("form1"));
	formData.append("data",json1);
	formData.append("stateId",stateId);
	formData.append("outStockToken",outStockToken);
	formData.append("salesCategory",salesCategory);
	formData.append("warehouseNo1",warehouseNo1);
	$.ajax({
		url :  "outstock/addOutStock",
		type : "post",
		data :formData,
		dataType : "json",
		success : function(result){
			if (result.msgCode =='Y'){
				$('#form1').form('clear');
				$('#itemsdg').datagrid('loadData', { total: 0, rows: [] });  
				$('#itemsdg1').datagrid('loadData', { total: 0, rows: [] }); 
				if(result.msg!='9'){//9表示删除
					editRow(result.msg,'op');//查看详情窗口
				}
				$.ajax({
			        url: 'outstock/getToken',
			        type: "post",
			        success: function (text) {
			        	$('#outStockToken').val(text.outStockToken);
			        },
			        error: function (jqXHR, textStatus, errorThrown) {
			        	$.messager.show({
							title: 'Error',
							msg: jqXHR.responseText
						});
			        }
			    });
				$("#selectLotNo").dialog('close');
				$("#add").dialog('close');
			} else {
				$.messager.alert('提示',result.msg,'error');
			}
		}
	});
	
/* 	$('#form1').form('submit',{
			url: url,
			onSubmit: function(){
				//if(stateId!=null && stateId=='2'){
					var totalWeighing = $("#totalWeighing").textbox('getValue');
		        	var deliveryNo = $('#deliveryNo').textbox('getValue');
		        	var a;
		        	$.ajax({
		        		async: false,
		        		url: 'outstock/valiTotalWeing',
				        type: "post",
				        data:{
				        	totalWeighing:totalWeighing,
				        	deliveryNo:deliveryNo
				        },
				        success: function (text) {
				        	if(text.error!=null && text.error=='N'){
				        		$.messager.alert('提示',text.errorMsg,'error');
				        		a=1;
				        	}else {
								a = 2;
							}
				        },
				        error: function (jqXHR, textStatus, errorThrown) {
				        	a = 2;
				        	$.messager.show({
								title: 'Error',
								msg: jqXHR.responseText
							});
				        }
				    });
				//}
				if(a == 1){
	  				return false;
	  			} 
	  			return true;
			},
			queryParams:{
				data:json1,
				stateId:stateId,
				outStockToken:outStockToken,
				salesCategory:salesCategory,
				warehouseNo1 :warehouseNo1,
			},
			success: function(result){
				var result = eval('('+result+')');
				if (result.msgCode =='Y'){
					$('#form1').form('clear');
					$('#itemsdg').datagrid('loadData', { total: 0, rows: [] });  
					$('#itemsdg1').datagrid('loadData', { total: 0, rows: [] }); 
					if(result.msg!='9'){//9表示删除
						editRow(result.msg,'op');//查看详情窗口
					}
					$.ajax({
				        url: 'outstock/getToken',
				        type: "post",
				        success: function (text) {
				        	$('#outStockToken').val(text.outStockToken);
				        },
				        error: function (jqXHR, textStatus, errorThrown) {
				        	$.messager.show({
								title: 'Error',
								msg: jqXHR.responseText
							});
				        }
				    });
					$("#selectLotNo").dialog('close');
					$("#add").dialog('close');
				} else {
					$.messager.alert('提示',result.msg,'error');
				}
			}
		});  */
}
function getDeliveryNote(){
	var state='';
	var outStateId;
	var outStockState=$('#outStockState').textbox('getValue');
	if(outStockState=='待制单'){
		outStateId='0';
	}else if(outStockState=='已制单'){
		outStateId='1';
	}else if(outStockState=='已出库'){
		outStateId='2';
	}else if(outStockState=='已作废'){
		outStateId='9';
	}
	$('#deliveryNoInfo').datagrid({
        iconCls: 'icon-save',
        width: "100%",
    	height: 200,
    	fitColumns:true,
        nowrap: true,
        autoRowHeight: false,
        striped: true,
        collapsible: true,
    	singleSelect:true,
        sortOrder: 'desc',
        remoteSort: false,
        rownumbers:true,
        checkOnSelect: true,
        url: 'outstock/getDeliveryNoInfo?deliveryNo='+$("#deliveryNo1").val()+'&outStateId='+outStateId,
        idField: 'deliveryNo',
        columns: [[
    		{field:'deliveryNo',title:'送货单号'},
            {field:'deliveryDate',title:'送货日期'},
            {field:'statusName',title:'状态'},
            {field:'companyName',title:'收货公司'},
            {field:'outstockWeight',title:'出库重量(KG)'},
            {field:'outstockWeighing',title:'出库过磅重量(KG)'},
            {field:'deliveryWeight',title:'预计送货总量(吨)'},
            {field:'contact',title:'创建人'},
            {field:'createTime',title:'创建时间'}
        ]],
        onDblClickRow:function(index,row){ 
        	var row=$('#deliveryNoInfo').datagrid('getRows')[index];
        	$('#deliveryNo').textbox('setValue',row.deliveryNo);
        	$("#delivery").dialog('close');
  		},
    });
	 $("#delivery").dialog('open');
}
//全部出库
function outStockTotal(){
	var warehouseNo1=$('#warehouseNo1').val();
	var salesCategory=$('#salesCategory').combobox('getValue');
	if(warehouseNo1==null || warehouseNo1==""){
		$.messager.alert('提示','操作失败!请选择出库仓库','error');
		return;
	}
	if(salesCategory==null || salesCategory=='--请选择品类--'){
		salesCategory='';
		$.messager.alert('提示','操作失败!请选择出库品类','error');
		return;
	}
	$('#itemsdgShow').datagrid({
		title: '按批次显示',
        width: "100%",
    	height: 300,
    	fitColumns:false,
        nowrap: true,
        autoRowHeight: false,
        striped: true,
        collapsible: true,
    	singleSelect:true,
        remoteSort: false,
        rownumbers:true,
        checkOnSelect: true,
        url: 'outstock/outStockShowGropyByLot?warehouseNo='+$('#warehouseNo1').val()+'&salesCategory='+salesCategory,
        columns: [[
              {field:'lotNo',title:'批次号',width:170,align:'center'},
        	  {field:'boxCode',title:'箱号',width:110,align:'center'},
        	  {field:'owner',title:'货主',width:80,align:'center'},
              {field:'configName',title:'商品类型',width:140,align:'center'},
              {field:'totalQuanlity',title:'总数量',width:80,align:'center'},
              {field:'totalWeight',title:'总重量(kg)',width:80,align:'center'},
              {field:'totalCost',title:'总成本价格(元)',width:100,align:'center'}
        ]],
        pagination: false
    }); 
	$('#itemsdg').datagrid({
        title: '按详情显示',
        width: "100%",
    	height: 300,
    	fitColumns:true,
        nowrap: true,
        autoRowHeight: false,
        striped: true,
        collapsible: true,
        resizable : false,
    	singleSelect:true,
        remoteSort: false,
        rownumbers:true,
        checkOnSelect: true,
        url: 'outstock/outStockTotal?warehouseNo='+$('#warehouseNo1').val()+'&salesCategory='+salesCategory,
        columns: [[
        	  {field:'productId',title:'商品ID',hidden:true},
        	  {field:'inventoryItemId',title:'库存ID',hidden:true},
              {field:'configName',title:'商品类型'},
              {field:'brandName',title:'品牌'},
              {field:'modelName',title:'型号'},
              {field:'companyName',title:'货主'},
              {field:'quanlity',title:'数量'},
              {field:'unit',title:'单位'},
              {field:'commWeight',title:'单位重量'},
              {field:'weight',title:'重量(KG)'},
              {field:'cost',title:'成本价格(元)'},
              {field:'lotNo',title:'批次号'},
        ]],
        pagination: false,
        onLoadSuccess: function(date){
    		$('#totalWeight').textbox('setValue',date.weight);
    		$('#totalQuanlity').textbox('setValue',date.quanlity);
    		$('#Cost').textbox('setValue',date.cost);
    		$("#totalWeighing").textbox({readonly:false,prompt:"请填写过磅重量"}); //关闭只读
    	},
    });
	$('#itemsdg1').datagrid({
	    title: '按商品显示',
        width: "100%", 
    	height: 300,
    	fitColumns:true,
        nowrap: true,
        autoRowHeight: false,
        striped: true,
        collapsible: true,
    	singleSelect:true,
        remoteSort: false,
        rownumbers:true,
        checkOnSelect: true,
		url: 'outstock/outStockTotalBGroupBy?warehouseNo='+$('#warehouseNo1').val()+'&salesCategory='+salesCategory,
        columns: [[
              {field:'configName',title:'商品类型',width:80},
              {field:'brandName',title:'品牌',width:50},
              {field:'modelName',title:'型号',width:50},
              {field:'unit',title:'单位',width:50},
              {field:'commWeight',title:'单位重量',width:50},
	          {field:'totQuanlity',title:'总数量',width:50},
	          {field:'totWeight',title:'总重量(KG)',width:50},
	          {field:'totCost',title:'总成本(元)',width:50},
        ]],
        pagination: false,
	}); 
}

//构造json数据传送到服务器  
function getJsonDate(){
    var rowsData = $('#itemsdg').datagrid('getRows');  
	var json = [];  
	var loc;  
	$.each(rowsData, function (i) {  
	     loc= {  
			     "quanlity": rowsData[i].quanlity,  
			     "inventoryItemId":rowsData[i].inventoryItemId
	     };  
	     json.push(loc);  
	 });
	 json = JSON.stringify(json); //转换成json数据  
	 return json;
}

function getWarehouse(){
	var state='';
	var inStockId;
	var outStockState=$('#outStockState').textbox('getValue');
	if(outStockState=='待制单'){
		inStockId='0';
	}else if(outStockState=='已制单'){
		inStockId='1';
	}else if(outStockState=='已出库'){
		inStockId='2';
	}else if(outStockState=='已作废'){
		inStockId='9';
	}
	if(inStockId!='1'){
		state=$("#warehouseNo1").val();
	}else if(inStockId=='1'){
		state='add';
	}
	$('#wareHouseInfo').datagrid({
        iconCls: 'icon-save',
        width: "100%",
    	height: 200,
    	fitColumns:true,
        nowrap: true,
        autoRowHeight: false,
        striped: true,
        collapsible: true,
    	singleSelect:true,
        sortOrder: 'desc',
        remoteSort: false,
        rownumbers:true,
        checkOnSelect: true,
        url: 'instock/getWarehouse',
        queryParams:{
        	wareHouseNo:state,
        	op:'out'
        },
        idField: 'warehouseNo',
        columns: [[
    		{field:'warehouseNo',title:'仓库编号'},
            {field:'warehouseName',title:'仓库名称'},
            {field:'contact',title:'负责人'},
            {field:'userPhone',title:'负责人手机号'},
            {field:'totalWeight',title:'库存'},
            {field:'areaName',title:'区域'},
            {field:'createTime',title:'创建时间'}
        ]],
        onDblClickRow:function(index,row){ 
        	var row=$('#wareHouseInfo').datagrid('getRows')[index];
        	$('#warehouseNo').textbox('setValue',row.warehouseNo+'('+row.contact+')');
        	$('#warehouseNo1').val(row.warehouseNo);
        	$("#wareHouse").window('close');
  		},
    });
	 $("#wareHouse").window('open');
}

function getOwner(warehouseNo){
	$('#owner').combogrid({    
	    fitColumns:true,
	    value:'--请选择货主--',    
	    idField:'saCustId',    
	    textField:'companyName',    
	    url:'instock/getAllSaleCust?warehouseNo='+warehouseNo, 
	    editable:false,
	    columns:[[    
	        {field:'saCustId',title:'客户id',hidden:true},   
	        {field:'companyName',title:'客户公司',width:180},  
	        {field:'contact',title:'客户',width:100}, 
	        {field:'tel',title:'电话',width:130}, 
	    ]]    
	});  
}

function editRow(outStockNo,op){verification("outstock","update")
	var delRole = verification("outstock","delete");
	var searchRole = verification("outstock","searchDetile");
	var addRole = verification("outstock","add");
	var updateRole = verification("outstock","update");
	if (searchRole == false) {
    	return;
	}
	$('#outStockNo').textbox('textbox').css('background','');
	$('#createUser').textbox('textbox').css('background','');
	$('#outStockState').textbox('textbox').css('background','');
	$('#totalWeight').textbox('textbox').css('background','');
	$('#totalQuanlity').textbox('textbox').css('background','');
	$('#Cost').textbox('textbox').css('background','');
	$('#itemsdgDiv').hide();
	$('#btn1').linkbutton('disable');
	$('#btn1').hide();
	$('#btn2').linkbutton('disable');
	$('#btn2').hide();
	$.ajax({
	        url: 'outstock/getOutstockInfoByNo',
	        data: { 
	        	outStockNo:outStockNo
	        },
	        type: "post",
	        success: function (result) {  
	        	var stateTimes = result.stateTimes;
	        	var text=result.data;
	        	var loginId=result.loginId;
	        	$("#outStockNo").textbox('setValue',text.outStockNo);//赋值
	        	$("#preOutWeight").textbox('setValue',text.preOutWeight);//赋值text.PRE_OUT_WEIGHT.toFixed(2)
	        	$("#createUser").textbox('setValue',text.createName);//赋值
	       		$("#outStockState").textbox('setValue',text.status);//赋值
	       		$("#deliveryNo").textbox('setValue',text.deliveryNo);//赋值 
	      		$("#deliveryNo1").val(text.deliveryNo);//赋值 
	        	//$("#warehouseNo").textbox('setValue',text.WAREHOUSE_NO);//赋值
	        	$("#warehouseNo").textbox('setValue',text.warehouseNo+'('+text.wareEmploye+')');//赋值
	        	$("#warehouseNo1").val(text.warehouseNo);//赋值	
				if(text.statusNo==0){//待制单  改制单状态，修改
					$('#add').dialog({
				    	title: '确认出库单'
				   	});
					$('#allOutStock').linkbutton('enable');
					$('#allOutStock').show();
					$('#outStockByDeliveryNo').linkbutton('enable');
					$('#outStockByDeliveryNo').show();
					$('#delBtn').linkbutton('enable');
					$("#outStockDate").datebox({readonly:false});
					$("#totalWeighing").textbox({readonly:true,prompt:"请先选择出库方式"});
					$('#salesCategory').combo('enable');
					//$("#salesCategory").combobox('setValue','--请选择品类--');//赋值 
					$("#salesCategory").combobox('setValue',text.commTypeId);//赋值 
		       		$('#salesCategory').combo('disable');
					$('#salesCategory').combo('readonly', false);
					if (updateRole == true && loginId==text.employee) {
			    		$('#btn2').show();
			    		$('#btn2').linkbutton('enable');
			    	}else{
			    		$('#btn2').hide();
			    		$('#btn2').linkbutton('disable');
			    	}
					/* $('#totalWeighing').textbox({
				        onChange:function(){//校验过磅重量不能超过送货单的预计过磅重量
				        	var totalWeighing = $("#totalWeighing").textbox('getValue');
				        	var deliveryNo = $('#deliveryNo').textbox('getValue');
				        	$.ajax({
				        		async: false,
				        		url: 'outstock/valiTotalWeing',
						        type: "post",
						        data:{
						        	totalWeighing:totalWeighing,
						        	deliveryNo:deliveryNo
						        },
						        success: function (text) {
						        	if(text.error!=null && text.error=='N'){
						        		$.messager.alert('提示',text.errorMsg,'error');
						        	}
						        	//$("#totalWeighing").textbox({onChange:function(){alert("222")}});
						        },
						        error: function (jqXHR, textStatus, errorThrown) {
						        	$.messager.show({
										title: 'Error',
										msg: jqXHR.responseText
									});
						        }
						    });
				        }
				    }); */
					var nowDate=getNowFormatDate();
					$('#outStockDate').datebox({    
					    required:true,
					    editable:false,
					    value:'nowDate',
					    onSelect:function(start){
					    	var now = new Date();
					    	if(start > now){
					    		$.messager.alert('提示','操作失败!日期不能超过当前时间','error');
					    		$('#outStockDate').datebox('setValue','');
					    	}
				 		}
					});
	        	}else{
					$('#add').dialog({
				    	title: '出库单详情'
				   	});
					$('#btn2').hide();
					$('#btn2').linkbutton('disable');
					$('#allOutStock').linkbutton('disable');
					$('#allOutStock').hide();
					$('#outStockByDeliveryNo').linkbutton('disable');
					$('#outStockByDeliveryNo').hide();
					$('#delBtn').linkbutton('enable');
					$("#totalWeighing").textbox({readonly:true});
		        	$("#outStockDate").datebox({readonly:true});
		        	$('#outStockDate').datebox('setValue',text.outStockDate);
		       		$("#totalWeighing").textbox('setValue',text.totalWeighing);//赋值
		       		$('#itemsdgShow').datagrid({
		       		 	title: '按批次显示',
		       			width: "100%",
		            	height: 300,
		                nowrap: true,
		                autoRowHeight: false,
		                striped: true,
		                resizable : false, 
		                collapsible: true,
		            	singleSelect:true,
		                remoteSort: false,
		                rownumbers:true,
		                checkOnSelect: true,
		                url: 'outstock/outStockItmsGropyByLot?outStockNo='+$('#outStockNo').textbox("getValue"),
		                columns: [[
			   	           	  {field:'lotNo',title:'批次号',width:170,align:'center'},
				        	  {field:'boxCode',title:'箱号',width:110,align:'center'},
				        	  {field:'owner',title:'货主',width:80,align:'center'},
				              {field:'configName',title:'商品类型',width:140,align:'center'},
				              {field:'totalQuanlity',title:'总数量',width:80,align:'center'},
				              {field:'totalWeight',title:'总重量(kg)',width:80,align:'center'},
				              {field:'totalCost',title:'总成本价格(元)',width:100,align:'center'}
		                ]],
		                pagination: false,
		                onLoadSuccess: function(date){
		                	$('#totalWeight').textbox('setValue',date.weight);
		            		$('#totalQuanlity').textbox('setValue',date.quanlity);
		            		$('#Cost').textbox('setValue',date.cost);
		            	}
		            });	
		       		$("#salesCategory").combobox('setValue',text.commTypeId);//赋值 
		       		$('#salesCategory').combo('disable');
		       		$('#itemsdg1').datagrid({
            		    title: '按商品显示',
            	        width: "100%", 
            	    	height: 300,
            	    	//fitColumns:true,
            	        nowrap: true,
            	        autoRowHeight: false,
            	        striped: true,
            	        collapsible: true,
            	    	singleSelect:true,
            	        remoteSort: false,
            	        rownumbers:true,
            	        checkOnSelect: true,
            			url: 'outstock/outStockItemsByCom?outStockNo='+text.outStockNo,
            	        columns: [[
            	          {field:'configName',title:'商品类型',width:100},
          	              {field:'brandName',title:'品牌',width:60},
          	              {field:'modelName',title:'型号',width:60},
          	              {field:'unit',title:'单位',width:50},
          	              {field:'commWeight',title:'单位重量',width:50},
          		          {field:'totQuanlity',title:'总数量',width:60},
          		          {field:'totWeight',title:'总重量(KG)',width:60},
          		          {field:'totCost',title:'总成本(元)',width:60},
            	        ]],
            	        pagination: false,
                	}); 
	        	}
	        	$("#add").dialog('open'); 
	        	var conf={
	        			textAlign:'left',//设置文字位置,left在点上方,center在线上方
	        			lineWidth:200//设置线条长度
		           	    };
		        $(".pro").empty().timeLines(stateTimes,conf);
	        	if(op!=null && op=='op'){
	        		$.messager.alert('提示','操作成功','info');
	        	}
	        	//按钮控制
	        	if (delRole == false || text.statusNo==9) {
	        		$('#delBtn').hide();
		    	}else{
		        	$('#delBtn').show();
		    	}
	        },
	        error: function (jqXHR, textStatus, errorThrown) {
	        	$.messager.show({
					title: 'Error',
					msg: jqXHR.responseText
				});
	        }
	    });
}
//按批次出库
function outStockByLotNo(){
	var warehouseNo=$('#warehouseNo1').val();
	var salesCategory=$('#salesCategory').combobox('getValue');
	if(warehouseNo==null || warehouseNo==""){
		$.messager.alert('提示','操作失败!请选择出库仓库','error');
		return;
	}
	if(salesCategory==null || salesCategory=='--请选择品类--'){
		salesCategory='';
		$.messager.alert('提示','操作失败!请选择出库品类','error');
		return;
	}
  	$('#stockTotalInfo').datagrid({
 		//top:'20px',
        width: "100%",
    	height: 160,
    	rownumbers: true,
    	url:'',
        columns: [[ 
        	 {field:'warehouseId', title: '仓库ID',hidden:true },
             {field:'areaId',title:'区域Id',hidden:true},
             {field:'commTypeId',title:'类型ID',hidden:true},
             {field:'lotNo',title:'批次号',width:200},
             {field:'warehouseName',title:'仓库'},
             {field:'commTypeName',title:'产品类型'},
             {field:'quanlity',title:'总数量(只)'},
             {field:'weight',title:'总重量(KG)'},
             {field:'cost',title:'总成本(元)'},
             {field:'stockDate',title:'入库日期'},
             {field:'inType',title:'入库类型'},
             {field:'source',title:'来源'},
             {field:'contact',title:'来源负责人'}
        ]],
    });
    $('#stockTotalDetilInfo').datagrid({
        top:'20px',
        width: "100%",
    	height: 160,
    	url:'',
        rownumbers:true,//显示序列
        idField: 'lotNo',
        columns: [[
        	{field:'lotNo',title:'批次号',width:200}, 
        	{field:'boxCode',title:'箱号',width:100},
            {field:'configName1',title:'商品类型' ,width:120 },
            {field:'brandName1',title:'品牌',width:80},
            {field:'modelName1',title:'型号',width:80},
            {field:'owner1',title:'货主',width:50},
            {field:'quanlity1',title:'数量',width:50},
            {field:'unit1',title:'单位',width:50},
            {field:'commWeight1',title:'单位重量',width:50},
            {field:'weight1',title:'重量(KG)',width:50},
            {field:'cost1',title:'成本价格(元)',width:50},
      ]],
        pagination: false 
    });
    $('#lotNototalWeight').textbox('setValue',"0.00");
    	$('#lotNototalQuanlity').textbox('setValue',"0.00");
    	$('#remainQuanlity').textbox('setValue',"0.00");
    	$('#remainWeight').textbox('setValue',"0.00");
    $('#selectLotNo').dialog('open');
    $('#wsOwner').combogrid({    
		panelWidth:506,
	    value:'--请选择货主--',    
	    idField:'saCustId',    
	    textField:'companyName',    
	    url:'instock/getAllSaleCust?warehouseNo='+warehouseNo+'&salesCategory='+salesCategory, 
	    editable:false,
	    multiple : true,
	    separator : ",",
	    columns:[[    
	        {field:'saCustId',title:'客户id',hidden:true},   
	        {field:'companyName',title:'客户公司',width:200},  
	        {field:'contact',title:'客户',width:150}, 
	        {field:'tel',title:'电话',width:180},
	    ]],
	    onChange:function(){
        	var wsOwner = $('#wsOwner').combogrid('getValues');
        	if(wsOwner!=null && wsOwner!="" && wsOwner!="--请选择货主--" ){
        		$('#stockTotalInfo').datagrid({
             		//top:'20px',
                    width: "100%",
                	height: 160,
                	rownumbers: true,
                	singleSelect: false,
                	url:'outstock/getStockTotalByLotNo?warehouseNo='+$('#warehouseNo1').val()+'&salesCategory='+salesCategory+'&owner='+wsOwner,
                	idField: 'lotNo',
                    onCheck:function(index,row){
                    	check1(row,warehouseNo,wsOwner,salesCategory);
                    },
                    onUncheck:function(index,row){
                    	check1(row,warehouseNo,wsOwner,salesCategory);
                    },
                    onCheckAll:function(rows){
                    	check1(rows,warehouseNo,wsOwner,salesCategory);
                    },
                    onUncheckAll:function(rows){
                    	check1(rows,warehouseNo,wsOwner,salesCategory);
                    },
                    columns: [[
                         {field:'ck', title:'选择', checkbox: true }, 
                         {field:'warehouseId', title: '仓库ID',hidden:true },
                         {field:'areaId',title:'区域Id',hidden:true},
                         {field:'commTypeId',title:'类型ID',hidden:true},
                         {field:'lotNo',title:'批次号',width:200},
                         {field:'boxCode',title:'箱号'},
                         {field:'warehouseName',title:'仓库'},
                         {field:'commTypeName',title:'产品类型'},
                         {field:'quanlity',title:'总数量(只)'},
                         {field:'weight',title:'总重量(KG)'},
                         {field:'cost',title:'总成本(元)'},
                         {field:'stockDate',title:'入库日期'},
                         {field:'inType',title:'入库类型'},
                         {field:'source',title:'来源'},
                         {field:'contact',title:'来源负责人'}
                    ]],
                }); 
        	}
        }
	});     
}
function check1(row,warehouseNo,wsOwner,salesCategory){
	var rows=$('#stockTotalInfo').datagrid("getChecked");
	var json=getCheckData(rows);
	ajax(json,warehouseNo,wsOwner,salesCategory);
}
//构造json数据传送到服务器  
function getCheckData(rows){
	var json = [];  
	var loc; 
	 $.each(rows, function (i) {  
	     loc= {"lotNo": rows[i].lotNo};  
	     json.push(loc);  
	 });  
	 json = JSON.stringify(json); //转换成json数据  
	 return json;
}

function ajax(json,warehouseNo,wsOwner,salesCategory){
	if(warehouseNo==null || warehouseNo==""){
		$.messager.alert('提示','操作失败!出库仓库不能为空','error');
		return;
	}
	if(salesCategory==null || salesCategory==""){
		$.messager.alert('提示','操作失败!出库品类不能为空','error');
		return;
	}
	if(wsOwner==null || wsOwner=="--请选择货主--" || wsOwner==""){
		$.messager.alert('提示','操作失败!请选择货主','error');
		return;
	}
	var wsOwner1 = $('#wsOwner').combogrid('getValues');
	$('#stockTotalDetilInfo').datagrid({
       top:'20px',
       width: "100%",
	   height: 160,
       nowrap: true,
       autoRowHeight: false,
       striped: true,
       collapsible: true,
	   	singleSelect:true,
       sortOrder: 'desc',
       remoteSort: false,
       rownumbers:true,
       checkOnSelect: true,
       rownumbers:true,//显示序列
       url:'outstock/outStockTotal?owner='+wsOwner,//要拼接
       queryParams: {
   	     json:json,
   	  	 warehouseNo:warehouseNo,
   		 salesCategory:salesCategory
	   },	   
       idField: 'lotNo',
       columns: [[
       	   {field:'lotNo',title:'批次号',width:200},
       	   {field:'boxCode',title:'箱号',width:100},
           {field:'configName',title:'商品类型',width:120},
           {field:'brandName',title:'品牌',width:80},
           {field:'modelName',title:'型号',width:80},
           {field:'owner',title:'货主',width:50},
           {field:'quanlity',title:'数量',width:50},
           {field:'unit',title:'单位',width:50},
           {field:'commWeight',title:'单位重量',width:50},
           {field:'weight',title:'重量(KG)',width:50},
           {field:'cost',title:'成本价格(元)',width:50},
     ]],
	 pagination: false ,
	 onLoadSuccess:function(date){ 
		$('#lotNototalWeight').textbox('setValue',date.weight);
     	$('#lotNototalQuanlity').textbox('setValue',date.quanlity);
     	var remainQuanlity=date.remainQuanlity;
     	if(remainQuanlity==null || remainQuanlity=='' || remainQuanlity=='0'){
     		$('#remainQuanlity').textbox('setValue','0.00');
     	}else{
     		$('#remainQuanlity').textbox('setValue',remainQuanlity);
     	}
     	var remainWeight=date.remainWeight;
     	if(remainWeight==null || remainWeight=='' || remainWeight=='0'){
     		$('#remainWeight').textbox('setValue','0.00');
     	}else{
     		$('#remainWeight').textbox('setValue',remainWeight);
     	}
  	 },
   });
}

function goOutStock(){
	var warehouseNo=$('#warehouseNo1').val();
	var salesCategory=$('#salesCategory').combobox('getValue');
	var wsOwner=$('#wsOwner').combogrid("getValues");
	if(warehouseNo==null || warehouseNo==""){
		$.messager.alert('提示','操作失败!出库仓库不能为空','error');
		return;
	}
	if(salesCategory==null || salesCategory=='--请选择品类--' || salesCategory==''){
		$.messager.alert('提示','操作失败!出库品类不能为空','error');
		return;
	}
	if(wsOwner==null || wsOwner=="--请选择货主--" || wsOwner==""){
		$.messager.alert('提示','请选择货主或点击返回','error');
		return;
	}
	var rows=$('#stockTotalInfo').datagrid("getChecked");
	if(rows.length==0){
		$.messager.alert('提示','请选择出库批次或点击返回','error');
		return;
	}
	var lotNos="";
	$.each(rows, function (i) {  
		 lotNos+=rows[i].lotNo+",";
	}); 
	$('#itemsdgShow').datagrid({
		title: '按批次显示',
        width: "100%",
    	height: 300,
    	fitColumns:false,
        nowrap: true,
        autoRowHeight: false,
        striped: true,
        collapsible: true,
    	singleSelect:true,
        remoteSort: false,
        rownumbers:true,
        checkOnSelect: true,
    	url: 'outstock/outStockShowGropyByLot?warehouseNo='+warehouseNo+'&owner='+wsOwner
		+'&lotNos='+lotNos+'&salesCategory='+salesCategory,
        columns: [[
              {field:'lotNo',title:'批次号',width:170,align:'center'},
        	  {field:'boxCode',title:'箱号',width:110,align:'center'},
        	  {field:'owner',title:'货主',width:80,align:'center'},
              {field:'configName',title:'商品类型',width:140,align:'center'},
              {field:'totalQuanlity',title:'总数量',width:80,align:'center'},
              {field:'totalWeight',title:'总重量(kg)',width:80,align:'center'},
              {field:'totalCost',title:'总成本价格(元)',width:100,align:'center'}
        ]],
        pagination: false
    });
	$('#itemsdg').datagrid({
		title: '按详情显示',
		width: "100%",
    	height: 300,
    	fitColumns:true,
        nowrap: true,
        autoRowHeight: false,
        striped: true,
        resizable : false, 
        collapsible: true,
    	singleSelect:true,
        remoteSort: false,
        rownumbers:true,
        checkOnSelect: true,
		url: 'outstock/outStockTotalByLotNo?warehouseNo='+warehouseNo+'&owner='+wsOwner
        		+'&lotNos='+lotNos+'&salesCategory='+salesCategory,
        onBeforeLoad: function(){
        	$.ajax({
                url: 'outstock/outStockTotalByLotNo?lotNos='+lotNos,
                async : true,
                type: "post",
                success: function (text) {
                	if (text.error =='N'){
                		$.messager.alert('提示',text.errorMsg,'error');
                		return false;
  					}else {
  						return true;
  					}
                },
                error: function (jqXHR, textStatus, errorThrown) {
                	$.messager.alert('提示','操作失败','error');
                }
        	});
        },
        columns: [[
        	  {field:'productId',title:'商品Id'},
              {field:'configName',title:'商品类型'},
              {field:'brandName',title:'品牌'},
              {field:'modelName',title:'型号'},
              {field:'companyName',title:'货主'},
              {field:'quanlity',title:'数量'},
              {field:'unit',title:'单位'},
              {field:'commWeight',title:'单位重量'},
              {field:'weight',title:'重量(KG)'},
              {field:'cost',title:'成本价格(元)'},
              {field:'lotNo',title:'批次号'},
        ]],
        pagination: false,
        onLoadSuccess: function(data){
        	$('#stockTotalInfo').datagrid('clearSelections');
        	$('#stockTotalInfo').datagrid('clearChecked');
        	$('#stockTotalInfo').datagrid('loadData', { total: 0, rows: [] });
	      	$('#stockTotalDetilInfo').datagrid('loadData', { total: 0, rows: [] });
    		$('#totalWeight').textbox('setValue',data.weight);
    		$('#totalQuanlity').textbox('setValue',data.quanlity);
    		$('#Cost').textbox('setValue',data.cost);
    		$('#itemsdg1').datagrid({
    		    title: '按商品显示',
    	        width: "100%", 
    	    	height: 300,
    	    	fitColumns:true,
    	        nowrap: true,
    	        autoRowHeight: false,
    	        striped: true,
    	        collapsible: true,
    	    	singleSelect:true,
    	        remoteSort: false,
    	        rownumbers:true,
    	        checkOnSelect: true,
    			url: 'outstock/outStockTotalByLotGroupBy?warehouseNo='+warehouseNo+'&owner='+wsOwner
    	        		+'&lotNos='+lotNos+'&salesCategory='+salesCategory,
    	        columns: [[
    	              {field:'configName',title:'商品类型',width:80},
    	              {field:'brandName',title:'品牌',width:60},
    	              {field:'modelName',title:'型号',width:60},
    	              {field:'unit',title:'单位',width:60},
    	              {field:'commWeight',title:'单位重量',width:60},
    		          {field:'totQuanlity',title:'总数量',width:60},
    		          {field:'totWeight',title:'总重量(KG)',width:60},
    		          {field:'totCost',title:'总成本(元)',width:60},
    	        ]],
    	        pagination: false,
    	        onLoadSuccess:function(){
    	        	$("#totalWeighing").textbox({readonly:false,prompt:"请填写过磅重量"}); //关闭只读
    	        	$('#stockTotalInfo').datagrid('clearSelections');
    	        	$('#stockTotalInfo').datagrid('loadData', { total: 0, rows: [] });
    		      	$('#stockTotalDetilInfo').datagrid('loadData', { total: 0, rows: [] }); 
    	        }
    	   }); 
    		$('#selectLotNo').window('close');
    	}
    }); 
}

function del(){
	var outStockToken=$('#outStockToken').val();
	var outStockNo=$('#outStockNo').textbox("getValue");
	if(outStockNo==null || outStockNo==""){
		$.messager.alert('提示','该出库单号不存在','error');
		return;
	}
	$.messager.confirm('提示','是否确删除？',function (r) {
		if(r){
			$('#delBtn').linkbutton('disable');
			var formData = new FormData(document.getElementById("form1"));
			formData.append("outStockNo",outStockNo);
			formData.append("stateId",'9');
			formData.append("outStockToken",outStockToken);
			$.ajax({
				url :  "outstock/addOutStockDel",
				type : "post",
				data :formData,
				dataType : "json",
				success : function(result){
					$('#delBtn').linkbutton('enable');
					//var result = eval('('+result+')');
					if (result.msgCode =='Y'){
						$('#form1').form('clear');
						$('#itemsdg').datagrid('loadData', { total: 0, rows: [] });  
						$.messager.alert('提示','操作成功','info');
						$("#add").dialog('close');
					} else {
						$.messager.alert('提示',result.msg,'error');
					}
				}
			});
			
	/* 		$('#form1').form('submit',{
					url: url,
					onSubmit: function(){
					},
					queryParams:{
						outStockNo:outStockNo,
						stateId:'9',
						outStockToken:outStockToken
					},
					success: function(result){
						$('#delBtn').linkbutton('enable');
						var result = eval('('+result+')');
						if (result.msgCode =='Y'){
							$('#form1').form('clear');
							$('#itemsdg').datagrid('loadData', { total: 0, rows: [] });  
							$.messager.alert('提示','操作成功','info');
							$("#add").dialog('close');
						} else {
							$.messager.alert('提示',result.msg,'error');
						}
					}
			});  */
		}else{
			return;
		}
	});
}

$(function () {	
	 $('#add').dialog({  
       onClose:function(){ 
      	 $('#form1').form('clear');
      	 $('#itemsdgShow').datagrid('loadData', { total: 0, rows: [] });
      	 $('#itemsdg1').datagrid('loadData', { total: 0, rows: [] });
      	 $('#itemsdg').datagrid('loadData', { total: 0, rows: [] });
      	 $("#delivery").dialog('close');
      	 $('#wareHouse').window('close');
      	 $('#selectLotNo').dialog('close');
       }  		
     });  
	 $('#selectLotNo').dialog({  
       onClose:function(){  
    	  // $('#stockTotalInfo').datagrid('clearSelections');
      		$('#delivery').dialog('close');
      		$('#wareHouse').window('close');
       }  
	 });  
});
function goClose(index){
	if(index=="1"){
		$('#stockTotalInfo').datagrid('clearSelections');
		$('#selectLotNo').dialog('close');  
		$('#stockTotalInfo').datagrid('loadData', { total: 0, rows: [] });
      	$('#stockTotalDetilInfo').datagrid('loadData', { total: 0, rows: [] }); 
	}else if(index=="2"){
		$('#add').dialog('close');  
	}
	$('#delivery').dialog('close');
	$('#wareHouse').window('close');
}
function doSearch(){
	var province = $('#province').combobox('getValue');
	var city = $('#city').combobox('getValue');
	var area = $('#area').combobox('getValue');
	var start = $('#start').datebox('getValue');
	var end = $('#end').datebox('getValue');
	var queryWarehouseNo = $("#queryWarehouseNo").textbox('getValue');
	var queryOutStockNo = $('#queryOutStockNo').textbox('getValue');
	var queryDeliveryNo = $('#queryDeliveryNo').textbox('getValue');
	var queryStatus = $('#queryStatus').combobox('getValue');
	var areaId="isEmpt";
	if (province == "--请选择--" || province == "") {
		province = "isEmpty";
	} else {
		areaId = province;
	}
	if (city != "--请选择--" && city != "请先选择省份" && city != "") {
		areaId = city;
	}
	if (area != "--请选择--" && area != "请先选择城市" && area != "") {
		areaId = area;
	}	
	if(queryWarehouseNo==null || queryWarehouseNo=='' || queryWarehouseNo=='undefined'){
		queryWarehouseNo='isEmpt';
	}else{
		queryWarehouseNo=queryWarehouseNo;
	}
	if(queryOutStockNo==null || queryOutStockNo=='' || queryOutStockNo=='undefined'){
		queryOutStockNo='isEmpt';
	}else{
		queryOutStockNo=queryOutStockNo;
	}
	if(queryDeliveryNo==null || queryDeliveryNo=='' || queryDeliveryNo=='undefined'){
		queryDeliveryNo='isEmpt';
	}else{
		queryDeliveryNo=queryDeliveryNo;
	}
	if(queryStatus==null || queryStatus=='' || queryStatus=='undefined' || queryStatus=='--请选择--'){
		queryStatus='isEmpt';
	}else{
		queryStatus=queryStatus;
	}
    $('#dg').datagrid('load',{
    	queryWarehouseNo : queryWarehouseNo,
    	queryOutStockNo : queryOutStockNo,
    	queryDeliveryNo : queryDeliveryNo,
    	queryStatus : queryStatus,
    	areaId : areaId,
		start : start,
		end : end
    });
}
function saveMark(){
	var markId = $('input:radio[name="markId"]:checked').val();
	var outStockNoMk = $('#outStockNoMk').val();
	var orderMemo = $('#orderMemo').val();
	$.ajax({ 
		async: false,
        type:'post',
        url:'outstock/updateOrderMemo',  
        data:{
        	markId : markId,
        	outStockNoMk : outStockNoMk,
        	orderMemo : orderMemo
        },
        dataType:'json',  
        success:function(data){
        	if(data.msgCode == "Y"){
	       		 $.messager.alert('提示','操作成功!','info');
	       		 $('#mark').dialog('close');
	       		 $('#dg').datagrid('reload');
	       	}else{
	       		$.messager.alert('提示',data.msg,'error');
	       	}
        },
        error : function() {  
       		$.messager.alert('提示','操作失败!','error'); 
   	    }
    });
}
</script>
</head>
<body>
    <div id="tb" style="margin-bottom:5px;">
    	<form id="searchform">
		  <span id="quoutStock">
		  <div class="inputArea1">
		  	<label>省份</label>：<input id="province" />
		  	<label>城市</label>：<input id="city" />
		  	<label>区域 </label>：<input id="area" />
		  </div>
		  <div class="inputArea1">
		    <label>状态</label>：<input type="text" id="queryStatus" /> 
		 	<label>仓库编号</label>：<input type="text" class="easyui-textbox" id="queryWarehouseNo" />
			<label>出库单号</label>：<input type="text" class="easyui-textbox" id="queryOutStockNo" />
		  </div> 
		  <div class="inputArea1">
			<label>送货单号</label>：<input type="text" class="easyui-textbox" id="queryDeliveryNo" />
			<label>创建时间</label>：<input id="start" type="text"></input> 
			<label style="text-align:center;text-align-last:center;margin-right:14px;">至</label><input id="end" type="text"></input>
			<a onclick="doSearch()" class="easyui-linkbutton" data-options="iconCls:'icon-search'" style="padding-left: 5px;padding-right: 5px">查询</a>
			<a class="easyui-linkbutton" data-options="iconCls:'icon-clear'" style="margin-left:5px;padding-left: 5px;padding-right: 5px" onclick="$('#searchform').form('clear');">清空</a>
		  </div> 
		  </span> 
		</form>
	</div>
	<table id="dg" style="align:center"> 
	</table> 
	<div id="mark">
  		<form id = "markfrom" action="" method="get" style="padding: 50px"> 
  			<input type="hidden" name="outStockNoMk" id="outStockNoMk">
  			<table>
  				<tr>
					<td align="right" width="100px;">
						<font color="red">*</font>
						 <span style="font-weight: 600;">标记:</span>
					</td>
					<td align="left" width="300px;">
						<label><input name="markId" type="radio" value="1" /><img src="../../images/1.png"> </label> 
						<label><input name="markId" type="radio" value="2" /><img src="../../images/2.png"> </label> 
						<label><input name="markId" type="radio" value="3" /><img src="../../images/3.png"> </label> 
						<label><input name="markId" type="radio" value="4" /><img src="../../images/4.png"> </label> 
						<label><input name="markId" type="radio" value="5" /><img src="../../images/5.png"> </label> 
						<label><input name="markId" type="radio" value="6" /><img src="../../images/6.png"> </label> 
					</td>
				</tr>
				<tr>
					<td align="right" width="100px;">
						<font color="red">*</font>
						 <span style="font-weight: 600;">标记信息:</span>
					</td>
					<td align="left" width="300px;">
						<textarea id='orderMemo'name="orderMemo" style="width: 300px;height: 200px;max-width: 300px;max-height: 200px;"></textarea>
					</td>
				</tr>
  				<tr>
					<td>&nbsp;</td>
					<td align="center" >
						<div align="center">
							<a class="easyui-linkbutton" data-options="iconCls:'icon-save'" onclick="saveMark()">提交</a>
						</div>
					</td>
				</tr>
  			</table>
		</form> 
  	</div>
	<div id="add" style="margin:0 auto;width:900px" >
  		<div style="width: 100%;position:relative;">
			<div class="pro"></div>
		</div>
  		<form action="outstock/addOutStock" method="post" id="form1">
	  		  <input type="hidden" id="outStockToken" >
	  		  <div style="margin: 0px auto;width:800px" align="center"><div style="text-align:justify;text-justify:distribute-all-lines;text-align-last:justify;width:200px"><h3 class="report-title">出库单</h3></div></div>
			  <fieldset style="margin:0 auto;border: 1px solid;width:800px">
			    <legend>出库信息</legend>
				  <div style="margin:0 auto;width:800px;" id="outStock1">
				  	  <div class="inputArea2">
					  	<label>单号</label>：<input id="outStockNo" name="outStockNo" class="easyui-textbox" type="text" data-options="readonly:true"/>
					  	<label>日期</label>：<input id="outStockDate" name="outStockDate" class="easyui-datebox" type="text" required="required"/>
					  	<label>制单人</label>：<input id="createUser" name="createUser" value="${sessionScope.login.contact}" class="easyui-textbox" type="text" data-options="readonly:true"/>
					  </div>
					  <div class="inputArea2">
					   	<label>状态</label>：<input id="outStockState" name="outStockState" class="easyui-textbox" type="text" data-options="readonly:true"/>
						<input id="outStockState1" name="outStockState1" type="hidden" value="1">
						<label>出库品类</label>：<input id="salesCategory" name="salesCategory" class="easyui-combobox" type="text" />
						<label>预计出库重量</label>：<input id="preOutWeight" name="preOutWeight" class="easyui-textbox" type="text" data-options="readonly:true"/>(KG)
					  </div>
					  <div class="inputArea2">
					    <span id="outOrder3"><label>仓库</label>：<input id="warehouseNo" name="warehouseNo" class="easyui-textbox" type="text" style="width: 110px" data-options="readonly:true" required="required"/></span>
						<input type="hidden" id="warehouseNo1" name="warehouseNo1" />
						<a href="javascript:void(0)" onclick="getWarehouse()" class="easyui-linkbutton" style="padding-left: 6px;padding-right: 6px">...</a>
					   	<label  style="margin-left: 10px">送货单号</label>：<input id="deliveryNo" name="deliveryNo" class="easyui-textbox" type="text" style="width: 125px" data-options="readonly:true" required="required"/>
						<input type="hidden" id="deliveryNo1" name="deliveryNo1" />
						<a href="javascript:void(0)" onclick="getDeliveryNote()" class="easyui-linkbutton" style="padding-left: 6px;padding-right: 6px">...</a>
					  </div>
				  	  <div style="width:100%;height:100px;position:relative;">
						  <fieldset style="padding:10px;float:left;">
							<legend>合计信息</legend>
							 <div class="inputArea1">
							   	<label>总重量</label>：<input id="totalWeight" name="totalWeight" class="easyui-textbox" type="text" style="width: 125px" data-options="readonly:true"/>(KG)
								<label>总成本</label>：<input id="Cost" name="Cost" class="easyui-textbox" type="text" style="width: 125px" data-options="readonly:true"/>&nbsp; (元)
							  </div>
							  <div class="inputArea1">
								<label>总数量</label>：<input id="totalQuanlity" name="totalQuanlity" class="easyui-textbox" type="text" style="width: 125px" data-options="readonly:true"/>
								<label style="margin-left:30px;">过磅重量</label>：<input id="totalWeighing" name="totalWeighing" class="easyui-textbox" type="text" style="width: 125px"/>&nbsp; (KG)
							  </div>
						   </fieldset>
						   <div style="position:absolute;right:0;bottom:0;">
				    	     <a id="allOutStock" href="javascript:void(0)" onclick="outStockTotal()" class="easyui-linkbutton">全部出库</a>
				    	     <a id="outStockByDeliveryNo" href="javascript:void(0)" onclick="outStockByLotNo()" class="easyui-linkbutton">按批次出库</a>
				    	   </div>
				    	</div>
			  			<div style="margin-top: 10px;" >
							<table id="lookdg"></table> 
			  			</div>
			  			<div id="itemsdgDivShow" style="margin-top: 10px;" align="center">
							<table id="itemsdgShow" align="center"></table> 
			  			</div>
			  			<div id="itemsdgDiv" style="margin-top: 10px;" >
							<table id="itemsdg"></table> 
			  			</div>
			  			<div style="margin-top: 10px;" id="toggel">
							<table id="itemsdg1"></table> 
			  			</div>
				    </div>
				    <div style="width:100%;text-align:center;padding:10px 0;">
				      <a href="javascript:void(0)" onclick="goClose('2')" class="easyui-linkbutton" style="padding-left: 10px;padding-right: 10px">取消</a>
					<!--   <c:if test="${sessionScope.rolBtn.get('outstock').containsKey('add') }"> -->
					  	<a id="btn1" onclick="addOutStockSubmit('1')" class="easyui-linkbutton" style="padding-left: 10px;padding-right: 10px;display: none">提交</a>
					  <!-- </c:if>
					  <c:if test="${sessionScope.rolBtn.get('outstock').containsKey('update') }"> -->
					  	<a id="btn2" onclick="addOutStockSubmit('2')" class="easyui-linkbutton" style="padding-left: 10px;padding-right: 10px;display: none">出库</a>
					 <!--  </c:if>
					  <c:if test="${sessionScope.rolBtn.get('outstock').containsKey('delete') }"> -->
					  	<a id="delBtn" href="javascript:void(0)" onclick="del()" class="easyui-linkbutton" style="padding-left: 10px;padding-right: 10px;display: none">删除</a>
					 <!--  </c:if> -->
				    </div>
			  </fieldset>
		</form>
	 </div>
     <div id="selectLotNo" style="margin:0 auto;width:900px" >
		    <div style="margin:0 auto;width:98%;">	

				 <fieldset style="margin:0 auto;border: 1px solid;width:870px;">
					  <legend align="left">选择合计信息</legend>
						 <div style="width:600px;float:left;">
						  <div class="inputArea1" id="outStock_sheet3">
							<span id="outWsOwner"><label>货主：</label>
							<input id="wsOwner" name="wsOwner" class="easyui-combogrid" type="text" /></span>
						  </div>
						  <div class="inputArea1">
							<label>总重量：</label>
							<input id="lotNototalWeight" name="lotNototalWeight" class="easyui-textbox" type="text" data-options="readonly:true"/>(KG)
							<label style="margin-left: 113px">总数量：</label>
							<input id="lotNototalQuanlity" name="lotNototalQuanlity" class="easyui-textbox" type="text" data-options="readonly:true"/>(只)
						  </div>
						  <div class="inputArea1">
							<label>剩余重量：</label>
							<input id="remainWeight" name="remainWeight" class="easyui-textbox" type="text" data-options="readonly:true"/>(KG)
							<label style="margin-left: 113px">剩余数量：</label>
							<input id="remainQuanlity" name="remainQuanlity" class="easyui-textbox" type="text" data-options="readonly:true"/>(只)
						  </div>
					  </div>
					  <div style="float:right;">
					  	 <a href="javascript:void(0)" onclick="goOutStock()"  style=" width: 60px; height: 40px" class="easyui-linkbutton">增加</a>
					 	 <a href="javascript:void(0)" onclick="goClose('1')" style=" width: 60px; height: 40px" class="easyui-linkbutton">返回</a>
					  </div>
					</fieldset>

    			<fieldset style="margin:0 auto;border: 1px solid;width:870px;">
    			<legend align="left">批次库存</legend>
    			<div id="dgid" style="margin-top: 10px;float: left;clear: left;width: 100%">
							<table id="stockTotalInfo" style="margin:0 auto;width:800px;line-height: 40px;">
							</table> 
    			</div>
    			</fieldset>

    			<fieldset style="margin:0 auto;border: 1px solid;width:870px;">
    			<legend align="left">批次库存详情</legend>
    			<div style="margin-top: 10px">
							<table id="stockTotalDetilInfo" style="margin:0 auto;width:800px;line-height: 40px;">
							</table> 
    			</div>
    			</fieldset>

		    </div>
	 </div>
	  <div id="wareHouse" style="margin:0 auto;width:900px">
	 	<table id="wareHouseInfo"></table>
	 </div>
	 <div id="delivery" style="margin:0 auto;width:900px">
	 	<table id="deliveryNoInfo"></table>
	 </div>
</body>
</html>