<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>门店信息</title>
<link rel="stylesheet" type="text/css" href="../../themes/default/easyui.css">
<link rel="stylesheet" type="text/css" href="../../themes/icon.css">
<link rel="stylesheet" type="text/css" href="../../themes/demo.css">
<script type="text/javascript" src="../../js/jquery.min.js"></script>
<script type="text/javascript" src="../../js/jquery.easyui.min.js"></script>
<script type="text/javascript" src="../../js/locale/easyui-lang-zh_CN.js"></script>
<script type="text/javascript"
	src="http://api.map.baidu.com/api?v=2.0&ak=S2XBCnEYouwQYSpqxcpX2BP1"></script>
<script type="text/javascript" src="../../js/datagrid-detailview.js"></script>
<script type="text/javascript" src="../global.js"></script>

<style type="text/css">
#allmap {
	width: 560px;
	height: 300px;
}

#allmap2 {
	width: 560px;
	height: 250px;
}
.cust_btnPos{
	position:absolute;
	top:40px;
	right:10px;
}
</style>

<script type="text/javascript">
  		var url;
  		var getProvince1;
  		var getCity;
  		var getArea;
  		var AreaIds;
  		var flag = false;
  		var flag2 = false;
  		var hig = 0,tableH = 0;
  		function MobileNo(no){
  			 var re = /^1[3-9]{1}\d{9}$/;
  			 if(!re.test(no)){
  		    	return false;
  		    }
  			 return true;
  		}
    	$(function () {
    		if($(window).width()>1500){
    			$("#cust_btn").addClass("cust_btnPos");
    		}
    		var years = [];
    		for (var i = 1979; i < new Date().getUTCFullYear()+1; i++) {
    			years.push({"year":i});
			}
			$('#phoneType').combobox({
	        	width:'100',
	        	height:'25',
				valueField: 'label',
				textField: 'value',
				panelHeight: '60',
				data: [
						{ label: 1,value: '智能机'},
						{ label: 2,value: '功能机'}
					  ],
				value: 1
			});
			$('#phoneType2').combobox({
	        	width:'100',
	        	height:'25',
				valueField: 'label',
				textField: 'value',
				panelHeight: '60',
				data: [
						{ label: 1,value: '智能机'},
						{ label: 2,value: '功能机'}
					  ],
				value: 1
			});
			$('#custLevel').combobox({
       	        valueField:'config_id', //值字段
       	        textField:'config_name', //显示的字段
       	        url:'customer/searchCustLevel',
       	        editable:false,//不可编辑，只能选择
       	        value:'--请选择--'
       	     });

    		$('#openTime').combobox({
		 		valueField:'year',
		 		textField:'year',
		 		width:'60',
		 		editable:false,
		 		data:years
			});
    		$('#openTime2').combobox({
		 		valueField:'year',
		 		textField:'year',
		 		width:'60',
		 		editable:false,
		 		data:years
			});
    		
    		$.ajax({
    			url: "customer/getAllCustState",
    	        type: "post",
    	        success: function (text) {
    	        	$('#custState').combobox({
    			 		valueField:'config_id',
    			 		textField:'config_name',
    			 		width:'150',
    			 		editable:false,
    			 		value: '--请选择--',
    			 		data: text
    				});
    	    		$('#custState2').combobox({
    			 		valueField:'config_id',
    			 		textField:'config_name',
    			 		editable:false,
    			 		value: '--请选择--',
    			 		data: text
    				});
    	        },
    	        error: function (jqXHR, textStatus, errorThrown) {
    	        	$.messager.alert('提示','加载失败，请刷新页面','error');
    	        	console.log(jqXHR);
    	        }
	    	});
    		$.ajax({
    			url: "customer/getAllProperty",
    	        type: "post",
    	        success: function (text) {
    	        	$('#property').combobox({
    			 		valueField:'config_id',
    			 		textField:'config_name',
    			 		width:'150',
    			 		editable:false,
    			 		value: '--请选择--',
    			 		data: text
    				});
    	        	$('#property2').combobox({
    			 		valueField:'config_id',
    			 		textField:'config_name',
    			 		width:'150',
    			 		editable:false,
    			 		value: '--请选择--',
    			 		data: text
    				});
    	        },
    	        error: function (jqXHR, textStatus, errorThrown) {
    	        	$.messager.alert('提示','加载失败，请刷新页面','error');
    	        	console.log(jqXHR);
    	        }
	    	});
    		$.ajax({
    			url: "customer/getAllCust",
    	        type: "post",
    	        success: function (text) {
    	        	$('#cust_name').combobox({
    			 		valueField:'config_id',
    			 		textField:'config_name',
    			 		editable:false,
    			 		value: '--请选择--',
    			 		data: text
    				});
    	    		$('#custType2').combobox({
    			 		valueField:'config_id',
    			 		textField:'config_name',
    			 		width:'150',
    			 		editable:false,
    			 		value: '--请选择--',
    			 		data: text
    				});
    				$('#custType').combobox({
    			 		valueField:'config_id',
    			 		textField:'config_name',
    			 		width:'150',
    			 		editable:false,
    			 		value: '--请选择--',
    			 		data: text
    				});
    	        },
    	        error: function (jqXHR, textStatus, errorThrown) {
    	        	$.messager.alert('提示','加载失败，请刷新页面','error');
    	        	console.log(jqXHR);
    	        }
	    	});
    		$('#custLabel2').combobox({
		 		url:'customer/getToCustLabel',
		 		valueField:'custLabelId',
		 		textField:'custLabelName',
		 		editable:false,
		 		value: '--请选择--',
			});
			$("#smsContent").keyup(
				function(){ 
					var smsContent = $("#smsContent").val();
					var len = smsContent.length;
					var smsnum = 62-parseInt(len);
					$("#smsnum").html(smsnum);
				}
			).keydown(
				function(event){
					var wic = event.which;
					if((wic > 47 && wic < 58) || (wic > 64 && wic < 91) || (wic > 95 && wic < 108) || (wic > 108 && wic < 112) || (wic > 185 && wic < 223) || wic == 32 || wic == 229){
						var smsContent = $("#smsContent").val();
						var len = smsContent.length;
						var smsnum = 62-parseInt(len);
						if(smsnum == 0){
	    	        		$.messager.alert('提示',"可输入字数已满",'info',function () {
	    						$("#smsnum").html(smsnum);
	    						return;
	    			        });
						}
					}
				}
			);

			win = $('#opCustLaberSet').window({
		    	title: '新增订单',
		    	width:'1030',
		    	height:'400',
		    	resizable:true, 
		    	top:0,
		    	left:0,
		    	closed:true,
		        minimizable: false,
		        maximizable: false,
		        collapsible: false,
		        fit:true,
		        onBeforeClose: function () { //当面板关闭之前触发的事件
					location.reload();
                }
			});
			
    		$('#province').combobox({
                valueField:'provinceId', //值字段
                textField:'provinceName', //显示的字段
                url:'areaController/getAllProvince',
                editable:false,//不可编辑，只能选择
                width:'100',
                value:'--请选择--',
                onSelect:function(){
                	/* push(); */
                	var province = $(this).combobox('getValue');
                    $('#city').combobox({
                    valueField:'cityId', 
                    textField:'cityName',
                    url:'areaController/getCityByProvinceId?provinceId='+province,
                    required:true,
                    editable:false,//不可编辑，只能选择
                    value:'--请选择--' 
                  }); 
                },
             });
    		$('#city').combobox({
                editable:false,
                width:'100',
                value:'请先选择省份',
               	onSelect:function(){
                	var city = $(this).combobox('getValue');
                    $('#area').combobox({
                    valueField:'areaId', 
                    textField:'areaName',
                    url:'areaController/getAreaByCityId?cityId='+city,
                    required:true,
                    editable:false,//不可编辑，只能选择
                    value:'--请选择--'
                   });
               	},
             	onLoadSuccess:function(){
               		$('#area').combobox({
        		 		width:'100',
        		 		editable:false,
               			value:'请先选择城市',
        			});
            	}
             });
    		$('#area').combobox({
 		 		width:'100',
 		 		editable:false,
 		 		value:'请先选择城市',
                onSelect:function(){
                	/* push(); */
                	var areaId = $(this).combobox('getValue');
                    $('#street').combobox({
	                    valueField:'stId', 
	                    textField:'stName',
	                    url:'areaController/getStreetByArea?areaId='+areaId,
	                    required:true,
	                    editable:false,//不可编辑，只能选择
	                    value:'--请选择--' 
                  }); 
                },
             	onLoadSuccess:function(){
               		$('#street').combobox({
        		 		width:'100',
        		 		editable:false,
               			value:'请先选择区/县',
        			});
            	}
 			});

       		$('#street').combobox({
		 		width:'100',
		 		editable:false,
       			value:'请先选择区/县',
                onSelect:function(){
                	/* push(); */
                	var streetId = $(this).combobox('getValue');
                    $('#country').combobox({
	                    valueField:'countryId', 
	                    textField:'countryName',
	                    url:'areaController/getCountryByStreet?streetId='+streetId,
	                    required:true,
	                    editable:false,//不可编辑，只能选择
	                    value:'--请选择--' 
                  }); 
                },
             	onLoadSuccess:function(){
               		$('#country').combobox({
        		 		width:'100',
        		 		editable:false,
               			value:'请先选择街道/镇',
        			});
            	}
			});

       		$('#country').combobox({
		 		width:'100',
		 		editable:false,
       			value:'请先选择街道/镇',
       			
			});
    		$('#province1').combobox({
                valueField:'provinceId', //值字段
                textField:'provinceName', //显示的字段
                url:'areaController/getAllProvince',
                editable:false,//不可编辑，只能选择
                width:'100',
                value:'--请选择--',
                onSelect:function(){
                	/* push(); */
                	var province = $(this).combobox('getValue');
              		getProvince1 = $(this).combobox('getText');
                    $('#city1').combobox({
                    valueField:'cityId', 
                    textField:'cityName',
                    url:'areaController/getCityByProvinceId?provinceId='+province,
                    required:true,
                    editable:false,//不可编辑，只能选择
                    value:'--请选择--' 
                  }); 
                },
             });
    		$('#city1').combobox({
                editable:false,
                width:'100',
                value:'请先选择省份',
               	onSelect:function(){
                	var city = $(this).combobox('getValue');
              		getCity = $(this).combobox('getText');
                    $('#area1').combobox({
                    valueField:'areaId', 
                    textField:'areaName',
                    url:'areaController/getAreaByCityId?cityId='+city,
                    required:true,
                    editable:false,//不可编辑，只能选择
                    value:'--请选择--'
                   });
               	},
             	onLoadSuccess:function(){
               		$('#area1').combobox({
        		 		width:'100',
        		 		editable:false,
               			value:'请先选择城市',
        			});
            	}
             });
    		$('#area1').combobox({
 		 		width:'100',
 		 		editable:false,
 		 		value:'请先选择城市',
                onSelect:function(){
                	var areaId = $(this).combobox('getValue');
                    $('#street1').combobox({
	                    valueField:'stId', 
	                    textField:'stName',
	                    url:'areaController/getStreetByArea?areaId='+areaId,
	                    required:true,
	                    editable:false,//不可编辑，只能选择
	                    value:'--请选择--' 
                  }); 
                },
             	onLoadSuccess:function(){
               		$('#street1').combobox({
        		 		width:'100',
        		 		editable:false,
               			value:'请先选择区/县',
               			
        			});
            	}
 			});
       		$('#street1').combobox({
		 		width:'100',
		 		editable:false,
       			value:'请先选择区/县',
                onSelect:function(){
                	var streetId = $(this).combobox('getValue');
                    $('#country1').combobox({
	                    valueField:'countryId', 
	                    textField:'countryName',
	                    url:'areaController/getCountryByStreet?streetId='+streetId,
	                    required:true,
	                    editable:false,//不可编辑，只能选择
	                    value:'--请选择--' 
                  }); 
                },
             	onLoadSuccess:function(){
               		$('#country1').combobox({
        		 		width:'100',
        		 		editable:false,
               			value:'请先选择街道/镇',
               			
        			});
            	}
			});

       		$('#country1').combobox({
		 		width:'100',
		 		editable:false,
       			value:'请先选择街道/镇',
       			
			});
    		$('#model_name').combobox({
    			valueField:'CONFIG_ID'
    			,textField:'CONFIG_NAME',
    			url:'commodity/getAllModel',
    			onSelect:function(){alert($(this).combobox('getValue'));/* push(); */},
 			});
			win = $('#w').window({
	        	title: '新增客户',
	        	width:'640',
	        	height:'400',
	        	resizable:false, 
	        	closed:true,
	            minimizable: false,
	            maximizable: false,
	            collapsible: false
	   		});

			$('#imgWin').dialog({
		    	title: '查看图片',
		    	width:700,
		    	height:600,
		    	resizable:false, 
		    	closed:true,
		        minimizable: false,
		        maximizable: false,
		        collapsible: false
				});
			win = $('#w2').window({
	        	title: '门店信息',
	        	width:640,
	        	height:700,
	        	resizable:false, 
	        	closed:true,
	            minimizable: false,
	            maximizable: false,
	            collapsible: false
	   		});
			win = $('#mark').window({
	        	title: '修改标识',
	        	width:640,
	        	height:400,
	        	resizable:false, 
	        	closed:true,
	            minimizable: false,
	            maximizable: false,
	            collapsible: false
	   		});
			win = $('#gsms').window({
	        	title: '短信',
	        	width:600,
	        	height:400,
	        	resizable:false, 
	        	closed:true,
	            minimizable: false,
	            maximizable: false,
	            collapsible: false,
                onBeforeClose: function () { //当面板关闭之前触发的事件
  					$('#gsmsfrom').form('clear');
                }
	   		});
			
			var toolbar = [];
			if(verification('customer','add')){
				toolbar.push({

	    			id: 'btnadd',
	   				text: '新增',
				    iconCls: 'icon-add',
				    handler: function () {
				    	$('#w').dialog('open');
				    	 // 百度地图API功能
				    	  var map = new BMap.Map("allmap");
				    		var point = new BMap.Point(116.331398,39.897445);
				    	  map.centerAndZoom(point, 14);
				    	  map.enableScrollWheelZoom();
				    	  // 添加带有定位的导航控件
				    	  var navigationControl = new BMap.NavigationControl({
				    	    // 靠左上角位置
				    	    anchor: BMAP_ANCHOR_TOP_LEFT,
				    	    // LARGE类型
				    	    type: BMAP_NAVIGATION_CONTROL_LARGE,
				    	    // 启用显示定位
				    	    enableGeolocation: true
				    	  });
				    	  map.addControl(navigationControl);
				    	  // 添加定位控件
				    	  var geolocationControl = new BMap.GeolocationControl();
				          var myGeo = new BMap.Geocoder();
				    	  geolocationControl.addEventListener("locationSuccess", function(e){
				    	    // 定位成功事件
				    	    var address = '';
				    	    address += e.addressComponent.province;
				    	    address += e.addressComponent.city;
				    	    address += e.addressComponent.district;
				    	    address += e.addressComponent.street;
				    	    address += e.addressComponent.streetNumber;
				    	    alert("当前定位地址为：" + address);
				    	  });
				    	  geolocationControl.addEventListener("locationError",function(e){
				    	    // 定位失败事件
				    	    alert(e.message);
				    	  });
				    	  map.addControl(geolocationControl);
						map.addEventListener("click", function (e) {
					        var pt = e.point;
							myGeo.getLocation(pt, function (rs) {
						          var addComp = rs.addressComponents;
						          function showConfirm() {
						        	  $.messager.confirm(addComp.province + ", " + addComp.city + ", " + addComp.district, '确定要更改此地址为您的店铺地址吗?', function(r){
				              				if (r){
												map.clearOverlays();
				              					var marker = new BMap.Marker(new BMap.Point(e.point.lng, e.point.lat));  // 创建标注
								                map.addOverlay(marker);
				              					$("#map_x").val(e.point.lng);
				              					$("#map_y").val(e.point.lat);
				               				}else {
												return;
											}
				              		});
						            /* var confirmPopup = $ionicPopup.confirm({
						              title: addComp.province + ", " + addComp.city + ", " + addComp.district,
						              template: '确定要更改此地址为您的店铺地址吗?'
						            });
						            confirmPopup.then(function (res) {
						              if (res) {
						                marker = new BMap.Marker(new BMap.Point(e.point.lng, e.point.lat));  // 创建标注
						                newmap.addOverlay(marker);
						                console.log(marker);
						              } else {
						              }
						            }); */
						          };
						          showConfirm();
						        });
						});
						$('#area1').combobox({
							onSelect:function(){
				                	/* push(); */
							  		getArea = $(this).combobox('getText');
				                	var areaId = $(this).combobox('getValue');
				                    $('#street1').combobox({
					                    valueField:'stId', 
					                    textField:'stName',
					                    url:'areaController/getStreetByArea?areaId='+areaId,
					                    required:true,
					                    editable:false,//不可编辑，只能选择
					                    value:'--请选择--' 
				                 	}); 
							  		var areass = getProvince1+getCity+getArea;
				                	// 将地址解析结果显示在地图上,并调整地图视野
				                	myGeo.getPoint(areass, function(point){
				                		if (point) {
				                			map.centerAndZoom(point, 14);
				                		}else{
				                			alert("您选择地址没有解析到结果!");
				                		}
				                	}, $('#city1').combobox('getText'));
				             }
						});
				    }
					
				});
			}
			
			
			
			
			
			
			form = win.find('form1');
			var tableH = Math.max(document.documentElement.scrollHeight,document.body.scrollHeight)-($('#dg').offset().top+30);
	    	$('#dg').datagrid({
	        	iconCls: 'icon-save',
	        	width: "100%",
	        	height: tableH,
	        	nowrap: true,
	        	onDblClickRow:function(index, field, value){
	        		if(hig==0){
	        			hig = tableH/2-10;
	        		}
	      			check(index);
	      		},
	        	autoRowHeight: false,
	        	striped: true,
	        	collapsible: true,
	        	singleSelect:true,
	        	/* url: 'customer/searchCustomer?op=search', */
	        	url: 'customer/search',
	        	remoteSort: false,
	        	rownumbers:true,
	        	checkOnSelect: true,
	        	idField: "cust_id",
	        	columns: [[
					{field:'mark_id',title:'标识',width:50,align:'center',
						formatter:function(value, row, index){//使用formatter格式化刷子
							return '<img onclick="javascript:domark('+value+','+index+');" src="../../images/'+value+'.png">';
					
						}},
		        	{ field: 're_mark',title: 're_mark',hidden:true, width: 60,align:'left' },
	        		{ field: 'cust_id',title: 'Id',hidden:true, width: 60,align:'left' },
	        		{ field: 'cust_phone', title: '手机(账号)', width: 120 ,align:'left'},
	        		{ field: 'cust_name', title: '负责人姓名', width: 100 ,align:'left'},
	        		{ field: 'shop_name', title: '店名', width: 140 ,align:'left'},
	                { field: 'shop_image', title: '图片', width: 60,align:'center',
	    				formatter:function(value, row, index){
	    					if(value==""){
	    						return value;
	    					}
	    					return "<img onclick=\"javascript:img1('"+value+"');\" src=\"../../images/Image_Ok.png\">";
	    				} },
	    			{field : 'config_name',title : '会员等级',width : 70,align:'left'},	
	        		{ field: 'area_id', title: '区域Id',hidden:true, width: 120,align:'left' },
	        		{ field: 'cust_area_id', title: '区域Id',hidden:true, width: 120,align:'left' },
	        		{ field: 'customer_type_id', title: '商户类型',hidden:true, width: 120,align:'left' },
	        		{ field: 'customer_type_name', title: '商户类型', width: 120,align:'left' },
	            	{ field: 'cust_level', title: '等级',hidden:true, width: 120,align:'left' },
	            	{ field: 'transactions', title: '交易次数',hidden:true, width: 120,align:'left' },
	            	{ field: 'cust_label_id', title: '标签id',hidden:true, width: 120,align:'left' },
	            	{ field: 'property_id', title: '产权id',hidden:true,width: 120,align:'left' },
	            	{ field: 'phone_type', title: '手机类型id',hidden:true,width: 120,align:'left' },
	            	{ field: 'phone_type_name', title: '手机类型',width: 60 ,align:'left'},
	            	{ field: 'channel_name', title: '注册渠道',width: 80 ,align:'left'},
	            	{ field: 'creat_by', title: '推荐人',width: 160 ,align:'left'},
	            	{ field: 'creat_time', title: '创建时间',width: 160,sortable:true},
	            	{ field: 'last_login_time', title: '最近登录时间',width: 160,sortable:true},
	            	{ field: 'login_num', title: '登录次数',width: 60 ,align:'right'},
	            	{ field: 'map_x', title: 'x坐标',hidden:true,width: 60,align:'left' },
	            	{ field: 'map_y', title: 'y坐标',hidden:true,width: 60,align:'left' },
	            	{ field: 'cust_label_name', title: '标签', width: 120 ,align:'left'},
	            	{ field: 'cust_state', title: '客户状态Id',hidden:true,width: 60,align:'left' },
	            	{ field: 'cust_state_name', title: '客户状态',width: 60 ,align:'left'},
	            	{ field: 'op', title: '操作', width: 180 ,align:'center',
	            		formatter: function (value, row, index) {
	                    	return (verification("customer","details")?"<a href=\"javascript:details("+index+");\">查看</a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;":"")+
	                    	(verification("customer","delete")?"<a href=\"javascript:del('"+index+"');\">删除</a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;":"")
	                    }
	            	}
	        	]],
	        	pagination: true,
	        	pageSize : 40, 
	        	pageList : [ 40, 80, 120 ],
	        	toolbar : toolbar
	            
	    	});

	    	/* // 增加一个新的 tab panel   
	    	$('#tt').tabs('add',{   
	    	    title:'New Tab',   
	    	    content:'Tab Body',   
	    	    closable:true  
	    	});  
	    	 // 获取选中的 tab panel 和它的 tab 对象   
	    	var pp = $('#tt').tabs('getSelected');   
	    	var tab = pp.panel('options').tab;    // 相应的 tab 对象 */

	    	$("input",$("#custPhone1").next("span")).blur(function(){
	    		var custPhone=$("#custPhone1").textbox('getValue');
				$.ajax({
					async: false,
					url : "customer/registerNo",
					type : "post",
					data : {
						name : custPhone
					},
					dataType : "json",
					success : function(data) {
					   if(data.success == "Y") {
			    	  		flag2 = false;
						}else {
			    			$.messager.alert('提示','手机（账号）已注册！','info');
			    	  		flag2 = true;
						}
					}
				});
	    	});
	    	
	    	if(verification("customer","update")){
	    		 $("#updBtn").css("display","");
	    	}
	  	});
    	function doSearch() {
    		var areaId = "isEmpty";
    		var province = $('#province').combobox('getValue');
    		var city = $('#city').combobox('getValue');
    		var area = $('#area').combobox('getValue');
    		var stId = $('#street').combobox('getValue');
    		var countryId = $('#country').combobox('getValue');
    		var custname = $('#cust_name').combobox('getValue');
    		var custState = $('#custState2').combobox('getValue');
    		var custPhone = $('#custPhone').val();
    		var custLabel2 = $('#custLabel2').combobox('getValue');
    		var custLevel = $('#custLevel').combobox('getValue');
    		if (custLevel == "" || custLevel == "--请选择--") {
    			custLevel = "isEmpty";
    		}
    		if (province == "--请选择--" || province == "") {
    			province = "isEmpty";
    		}else{
    			areaId = province;
    		}
    		if (city != "--请选择--" && city != "请先选择省份" && city != "") {
    			areaId = city;
    		}
    		if (area != "--请选择--" && area != "请先选择城市" && area != "") {
    			areaId = area;
    		}
    		if (stId != "--请选择--" && stId != "请先选择区/县" && stId != "") {
    			areaId = stId;
    		}
    		if (countryId != "--请选择--" && countryId != "请先选择街道/镇" && countryId != "") {
    			areaId = countryId;
    		}
    		if (custname== "" || custname== "--请选择--") {
    			custname = "isEmpty";
    		}
    		if (custState == "" || custState == "--请选择--") {
    			custState = "isEmpty";;
    		}
    		if (custPhone == "" || custPhone == "请输入手机号") {
    			custPhone = "isEmpty";
    		}
    		if (custLabel2 == "" || custLabel2 == "--请选择--") {
    			custLabel2 = "isEmpty";
    		}
    	    $('#dg').datagrid('load',{
    	    	areaId : areaId,
    	    	custname:custname,
    	    	custPhone:custPhone,
    	    	custState:custState,
    	    	custLabel:custLabel2,
    	    	custLevel:custLevel
    	    });
    	}
    	function check(index){

        	$('#dg').datagrid('resize',{
    	        height: hig,
        	});
    		$('#tt').panel('open');
	    	$('#tt').tabs({
	    		width: "100%",
	    		height:hig,
	    	    border:false,   
	    	    onSelect:function(title){     
	    	    }   
	    	});
	    	$('#dge').datagrid({
	            iconCls: 'icon-save',
	            width: "99%",
	    		height:hig-50,
	    		fitColumns:true,
	           /*  url: 'customer/searchCustomer?op=searchDec&CustId='+$('#dg').datagrid("getRows")[index].cust_id, */
       		    url: 'customer/searchDec',
       		 	queryParams: {
	       			CustId : $('#dg').datagrid("getRows")[index].cust_id
	 			},
	            nowrap: true,
	            autoRowHeight: false,
	            striped: true,
	            collapsible: true,
	            sortName: 'custOrderHeadId',
	            sortOrder: 'desc',
	            remoteSort: false,
	            rownumbers:true,
	            checkOnSelect: true,
	            idField: "custOrderHeadId",
	            frozenColumns: [[
	                { field: 'ck', checkbox: true },
	            ]],
	            columns: [[
					{ field: 'custOrderHeadId',title: '订单Id',hidden:true, width: 40 },
					{ field: 'custOrderNo', title: '单号', width: 120,align:'left'},
					{ field: 'shopName', title: '店名', width: 110 ,align:'left'},
					{ field: 'custPhone', title: '手机', width: 100 ,align:'left'},
					{ field: 'custId', title: '联系人ID',hidden:true, width: 90 },
					{ field: 'custName', title: '联系人', width: 90 ,align:'left'},
					{ field: 'custAddress', title: '地址', width: 160 ,align:'left'},
					{ field: 'areaId', title: '地区Id',hidden:true, width: 110 },
					{ field: 'areaName', title: '区域', width: 130 ,align:'left'},
					{ field: 'custOrderHeadType', title: '订单类型',hidden:true,width: 110 },
					{ field: 'totalQuantity', title: '总数', width: 60 ,align:'right'},
					{ field: 'predictTotalPrice', title: '总金额', width: 70 ,align:'right',formatter: function (value, row, index) {
            			if(value==null){
            				return 0;
            			}else{
            				return (parseFloat(value).toFixed(2) + '').replace(/\d{1,3}(?=(\d{3})+(\.\d*)?$)/g, '$&,');
            			}
                    }},
					{ field: 'custOrderState', title: '订单状态Id', hidden:true,width: 60 },
					{ field: 'stateName', title: '订单状态',width: 60 ,align:'left'},
					{ field: 'createTime', title: '回收时间', width: 120 },
					{ field: 'custCreateTime', title: '订单生成时间', width: 120 },
	            ]],
	            pagination: true,
	            pageSize : 40, 
	            pageList : [ 40, 80, 120 ]
	        });
	    	$('#wareList').datagrid({
	            iconCls: 'icon-save',
	            width: "99%",
	    		height:hig-50,
	    		fitColumns:true,
	            url: 'customer/wareList?CustId='+$('#dg').datagrid("getRows")[index].cust_id,
	            nowrap: true,
	            autoRowHeight: false,
	            striped: true,
	            collapsible: true,
	            sortName: 'custWarehouseListId',
	            sortOrder: 'desc',
	            remoteSort: false,
	            rownumbers:true,
	            checkOnSelect: true,
	            idField: "custWarehouseListId",
	            frozenColumns: [[
	                { field: 'ck', checkbox: true },
	            ]],
	            columns: [[
	              {field:'custWarehouseListId',title:'子订单Id',hidden:true,width:150},
	              {field:'warehouseNo',title:'仓库编号',hidden:true,width:120},
	              {field:'typeName',title:'商品类型',width:120, align:'left'},
	              {field:'commId',title:'商品编号',hidden:true,width:100},
	              {field:'brandName',title:'品牌',width:100, align:'left'},
	              {field:'modelName',title:'型号',width:100, align:'left'},
	              {field:'Unit',title:'单位',width:100, align:'left'},
	              {field:'unit_weight',title:'单位重量',hidden:true,width:100},
	              {field:'subtotalQuantity',title:'数量',width:100, align:'right'}
	            ]],
	            pagination: true,
	            pageSize : 10, 
	            pageList : [ 10, 20, 30, 40 ]
	        });
	    	$('#orderList').datagrid({
		        iconCls: 'icon-save',
		        width: "99%",
	    		height:hig-50,
	    		fitColumns:true,
		        nowrap: true,
	        	autoRowHeight: false,
	        	singleSelect: true,
	        	striped: true,
	        	collapsible: true,
	        	remoteSort: false,
	        	rownumbers:true,
	        	checkOnSelect: true,
		        url: 'customer/searchToOrder?sellMoblie='+$('#dg').datagrid("getRows")[index].cust_id,
		        idField: 'orderHeadId',
		        columns: [[
		            { field: 'orderHeadId', title: '订单id',hidden:true, width: 40 },
		            { field: 'orderMemo', hidden:true,title: '备注', width: 100 },
		            { field: 'markId', title: '标识', width: 40,align:'left'},
					{field: 'stateId',hidden:true, title: '状态', width: 80},
		            { field: 'State', title: '状态', width: 80 ,align:'left'},
		            { field: 'orderNo', title: '订单号', width: 140,sortable:true ,align:'left'},
		            { field: 'toWarehouseNo', title: '采购仓', width: 200 ,hidden:true,align:'left'},
		            { field: 'totalQuantity', title: '数量', width: 100,align:'right'},
		            { field: 'predictTotalWeight', title: '计算重量/Kg', width: 100,align:'right'},
		            { field: 'tradeTotalWeight', title: '过磅重量/Kg', width: 100,align:'right'},
					{ field: 'orderImage', title: '照片', width: 50,
						formatter:function(value, row, index){
							if(value==null){
								return value;
							}
							str = value.substr(value.length-3);
							if(str == 'mp4'){
								return "<video src=\"../../images/Image_Ok.png\" controls='controls'>";
							}else if (str == 'png'){
								return "<img onclick=\"javascript:img1('"+value+"');\" src=\"../../images/Image_Ok.png\">";
							}else if(str == 'jpg'){
								
							}
						}},
		            { field: 'predictTotalPrice', title: '行情价格', width: 100 ,align:'right',
							formatter: function (value, row, index) {
                        if (row != null) {
                            return (parseFloat(value).toFixed(2) + '').replace(/\d{1,3}(?=(\d{3})+(\.\d*)?$)/g, '$&,');
                      }
                    }},
		            { field: 'tradeTotalPrice', title: '成交金额', width: 100,align:'right',formatter: function (value, row, index) {
                        if (row != null) {
                            return (parseFloat(value).toFixed(2) + '').replace(/\d{1,3}(?=(\d{3})+(\.\d*)?$)/g, '$&,');
                      }
                    }},
		            { field: 'buyMoblie', title: '收货人', width: 140 ,align:'left'},
		            { field: 'createBy', title: '创建人', width: 100 ,align:'left'},
		            { field: 'createTime', title: '创建时间', width: 100,sortable:true},
		            { field: 'reMark', title: '备注', width: 100 }
		        ]], 
		        pagination: true,
		    	pageSize : 40, 
		    	pageList : [ 40, 80, 120 ]
		    });	
	    	$('#logList').datagrid({
		        iconCls: 'icon-save',
		        width: "99%",
	    		height:hig-50,
	    		fitColumns:true,
		        nowrap: true,
	        	autoRowHeight: false,
	        	singleSelect: true,
	        	striped: true,
	        	collapsible: true,
	        	remoteSort: false,
	        	rownumbers:true,
	        	checkOnSelect: true,
		        url: 'customer/searchCustLogin?custId='+$('#dg').datagrid("getRows")[index].cust_id,
		        idField: 'orderHeadId',
		        columns: [[
		            { field: 'Id', title: 'id',hidden:true, width: 40 },
		            { field: 'loginUserId',hidden:true, title: '客户Id', width: 100 },
		            { field: 'loginTime', title: '登录时间', width: 160,sortable:true }
		        ]], 
		        pagination: true,
		    	pageSize : 40, 
		    	pageList : [ 40, 80, 120 ]
		    });	

    		$('#detailedList').datagrid({
	            iconCls: 'icon-save',
	            width: "99%",
	    		height:hig-50,
	    		fitColumns:true,
	            url: 'customer/searchDet?phone='+$('#dg').datagrid("getRows")[index].cust_phone,
	            nowrap: true,
	            autoRowHeight: false,
	            striped: true,
	            collapsible: true,
	            sortName: 'BPL_ID',
	            sortOrder: 'desc',
	            remoteSort: false,
	            rownumbers:true,
	            checkOnSelect: true,
	            idField: "BPL_ID",
	            columns: [[
	            	{ field: 'BPL_ID',title: '流水Id',hidden:true, width: 40 },
	                { field: 'bpl_beforeintegral', title: '初始积分', width: 140 ,align:'right'},
	                { field: 'bpl_integralvalue', title: '积分值', width: 140 ,align:'right'},
	                { field: 'bpl_afterintegral', title: '变更后积分', width: 140 ,align:'right'},
	                { field: 'bpl_createtime', title: '创建时间', width: 200,sortable:true },
	                { field: 'config_name', title: '变更类型',width: 80 ,align:'left'},
	            ]],
	            pagination: true,
	            pageSize : 10, 
	            pageList : [ 10, 20, 30, 40 ]
	        });
    		$('#visitRecord').datagrid({
	            iconCls: 'icon-save',
	            width: "99%",
	    		height:hig-50,
	    		fitColumns:false,
	            url: 'customer/searchVisitRecord?custId='+$('#dg').datagrid("getRows")[index].cust_id,
	            nowrap: true,
	            autoRowHeight: false,
	            striped: true,
	            collapsible: true,
	            sortName: 'visitRecordId',
	            sortOrder: 'desc',
	            remoteSort: false,
	            rownumbers:true,
	            checkOnSelect: true,
	            idField: "visitRecordId",
	            columns: [[
	            	{ field: 'visitRecordId',title: '拜访Id',hidden:true, width: 40 },
	                { field: 'loginId', title: '用户Id', width: 200,hidden:true },
	                { field: 'userContact', title: '发送人', width: $(this).width()/3-66 ,align:'left'},
	                { field: 'visitRecordTime', title: '发送时间', width: $(this).width()/3 },
	                { field: 'visitRecordContent', title: '访问详情', width: $(this).width()/3 ,align:'left'},
	            ]],	
	            pagination: true,
	            pageSize : 10, 
	            pageList : [ 10, 20, 30, 40 ]
	        });
    	}
    	function submitSave(){
    		if(flag == true){
    			$.messager.alert('提示','不可连续点击确认！','info');
    			return;
    		}else{
    			if(flag == true){
	    			$.messager.alert('提示','手机（账号）已注册！','info');
	    			return;
    			}else{
    				var phoneType = $('#phoneType').combobox('getValue');
            		var areaId = "isEmpty";
            		var province = $('#province1').combobox('getValue');
            		var city = $('#city1').combobox('getValue');
            		var area = $('#area1').combobox('getValue');
            		var custName=$("#custName").textbox('getValue');
            		var custPhone=$("#custPhone1").textbox('getValue');
            		var shopName=$("#shopName").textbox('getValue');
            		var acreAge=$("#acreAge").textbox('getValue');
            		var custAddress=$("#custAddress").textbox('getValue');
            		var custType=$("#custType").combobox('getValue');
            		var openTime=$("#openTime").combobox('getValue');
            		var custMain=$("#custMain").textbox('getValue');
            		var property=$("#property").combobox('getValue');
            		var custAreaId = $('#country1').combobox('getValue');
            		var map_x = $("#map_x").val();
            		var map_y = $("#map_y").val();
            		console.log(custName);
            		
            		if (province == "--请选择--" || province == "") {
            			province = 0;
            		}else{
            			areaId = province;
            		}
            		if (city != "--请选择--" && city != "请先选择省份" && city != "") {
            			areaId = city;
            		}
            		if (area != "--请选择--" && area != "请先选择城市" && area != "") {
            			areaId = area;
            		}
            		if (custName == "") {
            			$.messager.alert('提示','负责人姓名不可为空！','info');
            			return;
        			}
            		if (custPhone == "") {
            			$.messager.alert('提示','手机（账号）不可为空！','info');
            			return;
        			}
            		if(!MobileNo(custPhone)){
            			$.messager.alert('提示','手机号码格式错误','info');
        	    		return;
        	    	}
            		if (shopName == "") {
            			$.messager.alert('提示','店铺名称不可为空！','info');
            			return;
        			}
            		if (areaId == "isEmpty") {
            			$.messager.alert('提示','请选择区域！','info');
            			return;
            		}
            		if (areaId.length < 6) {
            			$.messager.alert('提示','请将区域精确到区！','info');
            			return;
        			}
            		if (custAreaId == "--请选择--" || custAreaId == "请先选择街道/镇" || custAreaId == "") {
            			$.messager.alert('提示','请将区域精确到村/社区','info');
            			return;
            		}
            		if (custAddress == "") {
            			$.messager.alert('提示','地址不可为空！','info');
            			return;
        			}
            		if (custType == "") {
            			$.messager.alert('提示','客户类型不可为空！','info');
            			return;
        			}
            		if (property == "") {
            			property = 0;
        			}
              		flag = true;
            		$.ajax({
            	        url: "customer/add",
            	        data: { 
            	        	custName:custName,
            	        	custPhone:custPhone,
            	        	shopName:shopName,
            	        	acreAge:acreAge,
            	        	areaId:areaId,
            	        	custAddress:custAddress,
            	        	custType:custType,
            	        	openTime:openTime,
            	        	custMain:custMain,
            	        	property:property,
            	        	map_x:map_x,
            	        	map_y:map_y,
            	        	phoneType:phoneType,
            	        	custAreaId:custAreaId
            	        },
            	        type: "post",
            	        success: function (text) {
            	        	if (text.code == "1") {
            	        		$('#w').dialog('close');		// close the dialog
            					$('#form1').form('clear');
            	        		$.messager.alert('提示',text.msg,'info',function () {
            						location.reload();
            			        });
            					//$('#dg').datagrid('reload');	// reload the user data
            				}else if (text.code == "2") {
            					$.messager.alert('提示',text.msg,'info');
            					flag = false;
            				}
            	        },
            	        error: function (jqXHR, textStatus, errorThrown) {
            	        	flag = false;
            	        	$.messager.show({
            					title: 'Error',
            					msg: jqXHR.responseText
            				});
            	        }
            	    });
    			}
    		}
    	}

    	function img1(src) {
    		$('#img').attr("src",src);
    		$('#imgWin').dialog('open');
    	}
    	function getSendSms(index) {
	    	$('#gsms').dialog('open');
			var smsContent = $("#smsContent").val();
			var len = smsContent.length;
			var smsnum = 62-parseInt(len);
			$("#smsnum").html(smsnum);
	    	var custNames = $('#dg').datagrid("getRows")[index].cust_name+"("+$('#dg').datagrid("getRows")[index].cust_phone+")";
	    	$("#toCustName").html(custNames);
	    	$("#toCust").val($('#dg').datagrid("getRows")[index].cust_phone);
	    	$("#toCustId").val($('#dg').datagrid("getRows")[index].cust_id);
    	}
    	function details(index){
    		$('#details').dialog('open');
    		var custNames = $('#dg').datagrid("getRows")[index].cust_name+"("+$('#dg').datagrid("getRows")[index].cust_phone+")";
    	}
    	function doSendSms() {
    		var smsContent = $("#smsContent").val();
			if (smsContent == "" || smsContent == undefined) {
				$.messager.alert('提示',"短信内容不可为空",'info');
	                return;
			}
    		$.messager.confirm('提示', '是否确认发送？', function(r){
  				if (r){
  		    		var toCust = $("#toCust").val();
  		    		var toCustId = $("#toCustId").val();
  					$.ajax({
  		    	        url: "customer/custSendMessage",
  		    	        data: { 
  		    	        	toCust : toCust,
  		    	        	smsContent : smsContent,
  		    	        	toCustId : toCustId
  		    	        },
  		    	        type: "post",
  		    	        success: function (text) {
  		    	        	if (text.code == "1") {
  		    	        		$.messager.alert('提示',text.msg,'info',function () {
  		    	      	    		$('#gsms').dialog('close');
  		    			        });
  		    				}else if (text.code == "2") {
  		    					$.messager.alert('提示',text.msg,'info');
  		    				}
  		    	        },
  		    	        error: function (jqXHR, textStatus, errorThrown) {
  		    	        	$.messager.show({
  		    					title: 'Error',
  		    					msg: jqXHR.responseText
  		    				});
  		    	        }
  		    	    });
  				}else{
					return;
  				}
      		});
    	}
		function update(){
			$("#w2 .textbox").show();
			$("#w2 .label").hide();
			$("#upDiv").show();
			$("#detailsDiv").hide();
    	}
    	function details(index){
    		$("#detailsDiv").show();
    		$("#w2 .label").show();
    		$('#w2').dialog('open');
    		$("#w2 .textbox").hide();
    		$("#upDiv").hide();
    		url = "creditRating.do?actionCode=update";
    		var  row = $('#dg').datagrid("getRows")[index];
    		var areaId = row.area_id;
    		var areaId2 = row.cust_area_id;
    		var custId = row.cust_id;
    		var area = row.area_name;
    		var map_x = row.map_x;
    		var map_y = row.map_y;
    		var custState = row.cust_state;
    		var phoneType2 = row.phone_type;
    		if($(".textbox").is(':visible') == true){
    			$("#map_x2").val(map_x);
    			$("#map_y2").val(map_y);
        		$("#custId").val(custId);
        		$("#custName2").textbox('disable');
        		$("#custName2").textbox('setValue',row.cust_name);
        		$("#custPhone2").textbox('disable');
        		$("#custPhone2").textbox('setValue',row.cust_phone);
        		$("#shopName2").textbox('setValue',row.shop_name);
        		$("#acreAge2").textbox('setValue',row.acreage);
        		$("#areaId").val(areaId);
        		$("#custAddress2").textbox('setValue',row.cust_address);
        		$("#custType2").combobox('setValue',row.customer_type_id);
        		$("#openTime2").combobox('setValue',row.open_time);
        		$("#custMain2").textbox('setValue',row.cust_main);
        		$("#property2").combobox('setValue',row.property_id);
        		$("#custState").combobox('setValue',custState);
    			$('#phoneType2').combobox('setValue',phoneType2);
    		}
			
			$("#map_x2").val(map_x);
			$("#map_y2").val(map_y);
    		$("#custId").val(custId);
    		$("#custNamelabel").html(row.cust_name);
    		$("#custPhonelabel").html(row.cust_phone);
    		$("#shopNamelabel").html(row.shop_name);
    		$("#acreAgelabel").html(row.acreage);
    		$("#areaId").val(areaId);
    		$("#custAddresslabel").html(row.cust_address);
    		$("#custTypelabel").html(row.customer_type_name);
    		$("#openTimelabel").html(row.open_time);
    		$("#custMainlabel").html(row.cust_main);
    		$("#propertylabel").html(row.property_name);
    		$("#custStatelabel").html(row.cust_state_name);
			$('#phoneTypelabel').html(row.phone_type_name);
			
			var streetDatas = null, countryDatas = null;
			
	        $('#street2').combobox({
	                valueField:'stId', 
	                textField:'stName',
	                url:'areaController/getStreetByArea?areaId='+areaId,
	                required:true,
	                editable:false,//不可编辑，只能选择
	                value:'--请选择--' ,
                    onSelect:function(){
                    	/* push(); */
                    	var streetId2 = $(this).combobox('getValue');
                        $('#country2').combobox({
    	                    valueField:'countryId',
    	                    textField:'countryName',
    	                    url:'areaController/getCountryByStreet?streetId='+streetId2,
    	                    required:true,
    	                    editable:false,//不可编辑，只能选择
    	                    value:'--请选择--'
                      }); 
                    },
                    onLoadSuccess:function(data){
                    	  streetDatas = data;
      		        	for(var i = 0;i<streetDatas.length;i++){
      		        		if(streetDatas[i].stId == areaId2.substr(0,9)){
      		        			$("#streetlabel").html(streetDatas[i].stName);
      		        			/* console.log(streetDatas[i].stName); */
      		        		}
      		        	}
                    }
	          });
		    
            if (areaId2 != undefined && areaId2.length > 6) {
        		var areaId3 = areaId2.substr(0,9);
        		$("#street2").combobox('setValue',areaId3);
			}
            $('#country2').combobox({
		 		width:'100',
		 		editable:false,
       			value:'请先选择街道/镇',
       			
			});
    		$("#street2").siblings(".textbox").hide(); 
    		$("#country2").siblings(".textbox").hide();
	            if (areaId2 != undefined && areaId2.length > 9) {
	        		var areaId4 = areaId2.substr(0,9);
	                $('#country2').combobox({
	                    valueField:'countryId', 
	                    textField:'countryName',
	                    url:'areaController/getCountryByStreet?streetId='+areaId4,
	                    required:true,
	                    editable:false,//不可编辑，只能选择
	                    value:'--请选择--' ,
  	                  
	                    onLoadSuccess:function(data){
	                    	countryDatas = data;
	    		        	for(var i = 0;i<countryDatas.length;i++){
	    		        		if(countryDatas[i].countryId == areaId2){
	    		        			console.log(countryDatas[i].countryName);
	    		        			$("#countrylabel").html(countryDatas[i].countryName);
	    		        		}
	    		        	}
	                    }
	              });
	        		$("#country2").combobox('setValue',areaId2);
				}
                
				$.ajax({
	    	        url: "customer/getAreaName",
	    	        data: { 
	    	        	areaIds : areaId
	    	        },
	    	        type: "post",
	    	        success: function (text) {
	    	    		$("#area2").html(text.areaName);
	    	        },
	    	        error: function (jqXHR, textStatus, errorThrown) {
	    	        	$.messager.show({
	    					title: 'Error',
	    					msg: jqXHR.responseText
	    				});
	    	        }
	    	    });
			
    		 // 百度地图API功能
	    	  var map = new BMap.Map("allmap2");
	    	  var point;
				if(map_x != null && map_y != null){
	    			var point = new BMap.Point(map_x,map_y);
				}else{
		    		var point = new BMap.Point(116.331398,39.897445);
				}
	    	  map.centerAndZoom(point, 14);
	    	  map.enableScrollWheelZoom();
	    	  // 添加带有定位的导航控件
	    	  var navigationControl = new BMap.NavigationControl({
	    	    // 靠左上角位置
	    	    anchor: BMAP_ANCHOR_TOP_LEFT,
	    	    // LARGE类型
	    	    type: BMAP_NAVIGATION_CONTROL_LARGE,
	    	    // 启用显示定位
	    	    enableGeolocation: true
	    	  });
	    	  map.addControl(navigationControl);
	    	  // 添加定位控件
	    	  var geolocationControl = new BMap.GeolocationControl();
	          var myGeo = new BMap.Geocoder();
	    	  geolocationControl.addEventListener("locationSuccess", function(e){
	    	    // 定位成功事件
	    	    var address = '';
	    	    address += e.addressComponent.province;
	    	    address += e.addressComponent.city;
	    	    address += e.addressComponent.district;
	    	    address += e.addressComponent.street;
	    	    address += e.addressComponent.streetNumber;
	    	    alert("当前定位地址为：" + address);
	    	  });
	    	  geolocationControl.addEventListener("locationError",function(e){
	    	    // 定位失败事件
	    	    alert(e.message);
	    	  });
	    	  map.addControl(geolocationControl);
	    	// 将地址解析结果显示在地图上,并调整地图视野
					if(map_x != null && map_y != null){
	  					var marker = new BMap.Marker(new BMap.Point(map_x, map_y));  // 创建标注
		                map.addOverlay(marker);
					}else{
						myGeo.getPoint(area, function(point){
			          		if (point) {
			          			map.centerAndZoom(point, 14);
			          		}else{
			          			alert("您选择地址没有解析到结果!");
			          		}
			          	}, area);
					}
			map.addEventListener("click", function (e) {
		        var pt = e.point;
				myGeo.getLocation(pt, function (rs) {
			          var addComp = rs.addressComponents;
			          function showConfirm() {
			        	  $.messager.confirm(addComp.province + ", " + addComp.city + ", " + addComp.district, '确定要更改此地址为您的店铺地址吗?', function(r){
	              				if (r){
									map.clearOverlays();
	              					var marker = new BMap.Marker(new BMap.Point(e.point.lng, e.point.lat));  // 创建标注
					                map.addOverlay(marker);
	              					$("#map_x2").val(e.point.lng);
	              					$("#map_y2").val(e.point.lat);
	              					if (addComp.province == addComp.city) {
										$("#area2").html(addComp.city + "  " + addComp.district);
									}else{
										$("#area2").html(addComp.province + "  " + addComp.city + "  " + addComp.district);
									}
	              					$.ajax({
	              						async: false,
	              	                    type: "post",
	              	                    url: "/areaController/getAreaId",
	              	                    data:{
	              	                    	provinceName : addComp.province,
	              	                    	cityName : addComp.city,
	              	                    	areaName : addComp.district
	              	                    },
	              	                    dataType : "json",
	              	                    success: function(data){
	              	                    	if (data.success == 'Y') {
	              	                    		console.log(data.area)
	              	                    		AreaIds = data.area;
		              	          	            $('#street2').combobox({
		              	          	                valueField:'stId', 
		              	          	                textField:'stName',
		              	          	                url:'areaController/getStreetByArea?areaId='+AreaIds,
		              	          	                required:true,
		              	          	                editable:false,//不可编辑，只能选择
		              	          	                value:'--请选择--' ,
		              	          	          });
		              	          	            $('#country2').combobox({
			              	        		 		width:'100',
			              	      		 			editable:false,
			              	             			value:'请先选择街道/镇',
		              	             			
		              	      					});
	              	            			}else{
	              	            				$.messager.alert('提示','请联系管理员添加区域','info');
	              	            			}
	              	                    }
	              	                  });
					                console.log(marker);
	               				}else {
									return;
								}
	              		});
			            /* var confirmPopup = $ionicPopup.confirm({
			              title: addComp.province + ", " + addComp.city + ", " + addComp.district,
			              template: '确定要更改此地址为您的店铺地址吗?'
			            });
			            confirmPopup.then(function (res) {
			              if (res) {
			                marker = new BMap.Marker(new BMap.Point(e.point.lng, e.point.lat));  // 创建标注
			                newmap.addOverlay(marker);
			                console.log(marker);
			              } else {
			              }
			            }); */
			          };
			          showConfirm();
			        });
			});
    	}
    	function del(index){
    		var custId = $('#dg').datagrid("getRows")[index].cust_id;
    		var transactions = $('#dg').datagrid("getRows")[index].transactions;
    		var login_num = $('#dg').datagrid("getRows")[index].login_num;
    		
    		if (transactions != 0 || transactions != "") {
    			$.messager.alert('提示','此账号已投入使用，不可删除！','info');
    			return;
			}
    		if (login_num != 0 || login_num != "") {
    			$.messager.alert('提示','此账号已投入使用，不可删除！','info');
    			return;
			}
    		$.messager.confirm('提示', '是否删除？', function(r){
  				if (r){
  					$.ajax({
  		    	        url: "customer/deleteCu",
  		    	        data: { 
  		    	        	custId:custId
  		    	        },
  		    	        type: "post",
  		    	        success: function (text) {
  		    	        	if (text.code == "1") {
  		    	        		$('#w2').dialog('close');		// close the dialog
  		    					$('#form2').form('clear');
  		    	        		$.messager.alert('提示',text.msg,'info',function () {
  		    	        			$('#dg').datagrid('reload')
  		    			        });
  		    					//$('#dg').datagrid('reload');	// reload the user data
  		    				}else if (text.code == "2") {
  		    					$.messager.alert('提示',text.msg,'info');
  		    				}
  		    	        },
  		    	        error: function (jqXHR, textStatus, errorThrown) {
  		    	        	$.messager.show({
  		    					title: 'Error',
  		    					msg: jqXHR.responseText
  		    				});
  		    	        }
  		    	    });
   				}else {
					return;
				}
  		});
    	}
    	function clearForm1(){
    		/* window.location.reload(); */
    		 $('#tt').panel('close'); 
    		 $( '#dg').datagrid( 'reload');
    		 $('#dg').datagrid('resize',{
     	        height: tableH,
         	});
    		 $('#dg').datagrid('clearSelections'); 
    		$('#custLabel2').combobox({
		 		editable:false,
		 		value: '--请选择--',
			});
    		$('#custState2').combobox({
		 		editable:false,
		 		value: '--请选择--',
			});
			$("#custPhone").textbox("setValue", "");
			
			$('#cust_name').combobox({
		 		editable:false,
		 		value: '--请选择--',
			});
			$('#province').combobox({
				valueField: 'provinceId', //值字段
				textField: 'provinceName', //显示的字段
				url: 'areaController/getAllProvince',
				editable: false,//不可编辑，只能选择
				value: '--请选择--',
				});
			$('#city').combobox({
				data:  [],
				value: '请先选择省份',
				valueField:'id',
				textField:'text'
				});
			$('#area').combobox({
				data:  [],
				value: '请先选择城市',
				valueField:'id',
				textField:'text'
				});
			$('#street').combobox({
				data:  [],
				value: '请先选择区/县',
				valueField:'id',
				textField:'text'
				});
			$('#country').combobox({
				data:  [],
				value: '请先选择街道/镇',
				valueField:'id',
				textField:'text'
				});
			

			$('#custLevel').combobox({
				editable: false,//不可编辑，只能选择
				value: '--请选择--'
			});

			$('#orderState').combobox({
				editable: false,//不可编辑，只能选择
				value: '--请选择--'
			});

			$('#custType').combobox({
				editable: false,//不可编辑，只能选择
				value: '--请选择--'
			});
		}
    	
    	function submitSave2(){
    		console.log(1);
    		var custId = $("#custId").val(); 
    		var shopName=$("#shopName2").textbox('getValue');
    		var acreAge=$("#acreAge2").textbox('getValue');
    		var custAddress=$("#custAddress2").textbox('getValue');
    		var custType=$("#custType2").combobox('getValue');
    		var openTime=$("#openTime2").combobox('getValue');
    		var custMain=$("#custMain2").textbox('getValue');
    		var property=$("#property2").combobox('getValue');
    		var custState=$("#custState").combobox('getValue');
    		var AreaIds2 = $("#country2").combobox('getValue');
    		var map_x = $("#map_x2").val();
    		var map_y = $("#map_y2").val();
			//var phoneType = $('#phoneType2').combobox('getValue');
			var phoneType = 1;
    		if (AreaIds2 == "--请选择--" || AreaIds2 == "请先选择街道/镇" || AreaIds2 == "") {
    			$.messager.alert('提示','请选择村/社区','info');
    			return;
    		}
    		$.ajax({
    	        url: "customer/update",
    	        data: { 
    	        	shopName:shopName,
    	        	acreAge:acreAge,
    	        	custAddress:custAddress,
    	        	custType:custType,
    	        	openTime:openTime,
    	        	custMain:custMain,
    	        	property:property,
    	        	custId:custId,
    	        	custAreaId : AreaIds2,
    	        	custState:custState,
    	        	map_x:map_x,
    	        	map_y:map_y,
    	        	phoneType:phoneType
    	        },
    	        type: "post",
    	        success: function (text) {
    	        	if (text.code == "1") {
    	        		$('#w2').dialog('close');		// close the dialog
    					$('#form2').form('clear');
    	        		$.messager.alert('提示',text.msg,'info',function () {
    						location.reload();
    			        });
    					//$('#dg').datagrid('reload');	// reload the user data
    				}else if (text.code == "2") {
    					$.messager.alert('提示',text.msg,'info');
    				}
    	        },
    	        error: function (jqXHR, textStatus, errorThrown) {
    	        	$.messager.show({
    					title: 'Error',
    					msg: jqXHR.responseText
    					
    				});
    	        }
    	    }); 
    	}
    	function domark(er,index){
	    	$('#mark').dialog('open');
	    	var markId = $("input[type=radio][name=markId]");
	    	for (var i = 0; i < markId.length; i++) {
				if (markId[i].value == er) {
					markId[i].checked = true;
				}else {
					markId[i].checked = false;
				}
			}
    		var custId = $('#dg').datagrid("getRows")[index].cust_id;
    		var reMark = $('#dg').datagrid("getRows")[index].re_mark;
    		$("input[name='custIds1']").val(custId);
    		$("textarea[name='reMark']").val(reMark);
    	}
    	function saveMark(){
    		/* $('#markfrom').form('submit',{
    			url: "customer/saveMark",
    			onSubmit: function(){
    				return $(this).form('validate');
    			},
    			success: function(result){
    				var result = eval('('+result+')');
    				if (result.code == 1){
    					$('#mark').dialog('close');		// close the dialog
    					$('#markfrom').form('clear');
    					$.messager.alert('提示',result.msg,'info',function () {
                			$('#dg').datagrid('reload');
    			        });
    					
    				} else {
    					$.messager.alert('提示',result.msg,'info');
    				}
    			}
    		}); */
    		$.ajax({
  				url : "customer/saveMark",
  				type : "post",
  				data : new FormData(document.getElementById("markfrom")),
  				dataType : "json",
  				success : function(result){
  					if (result.code == 1){
    					$('#mark').dialog('close');		// close the dialog
    					$('#markfrom').form('clear');
    					$.messager.alert('提示',result.msg,'info',function () {
                			$('#dg').datagrid('reload');
    			        });
    				} else {
    					$.messager.alert('提示',result.msg,'info');
    				}
  				}
  			});
    	}
</script>
</head>
<body style="padding: 12px;position:relative;">
	<div class="inputArea1">
		<label>商户类型</label>：<input id="cust_name" class="easyui-combobox">
		<label>状态</label>：<input id="custState2"> 
		<label>商户标签</label>：<input id="custLabel2" class="easyui-combobox">
		<label>会员等级</label>：</span><input id="custLevel" name="custLevel" />
		<label>手机号</label>：<input id="custPhone" name="custPhone" class="easyui-textbox" style="line-height: 26px; border: 1px solid #ccc; width: 90px;">
	</div>
	<div class="inputArea1">
		<label>省份</label>：<input id="province">
		<label>城市</label>：<input id="city">
		<label>区域</label>：<input id="area">
		<label>镇名</label>：<input id="street">
		<label>村名</label>：<input id="country"> 
		</div>
	<div id="cust_btn" style="margin-top:5px;">
		<a class="easyui-linkbutton" data-options="iconCls:'icon-search'" onClick="doSearch()">查询</a>
		
		<a class="easyui-linkbutton" iconCls="icon-clear" onclick="clearForm1()">清空</a>
	</div>
	<div style="margin-bottom:10px;"></div>
	<table id="dg"></table>
	<div id="tt" class="easyui-panel" style="margin-top: 10px"
		closed='true'>
		<div title="客户订单">
			<table id="dge"></table>
		</div>
		<div title="库存详情">
			<table id="wareList"></table>
		</div>
		<div title="采购入库单">
			<table id="orderList"></table>
		</div>
		<div title="访问记录">
			<table id="logList"></table>
		</div>
		<div title="积分记录">
			<table id="detailedList"></table>
		</div>
		<div title="拜访记录">
			<table id="visitRecord"></table>
		</div>
	</div>
	<div id="w">
		<form action="creditRating.do" method="post" id="form1">
			<input type="hidden" name="actionCode" value="add"> 
			<input type="hidden" name="creditId" value=""> 
			<input type="hidden" id="map_x" value=""> 
			<input type="hidden" id="map_y" value="">
			<div class="window_content">
				<div class="window_row">
					<ul>
						<li>
							<span class="window_row_li"><font color="red">*</font>负责人姓名：</span>
							<input id = "custName" type="text" name="custName" value="" class="easyui-textbox" placeholder="角色的名称" />
						</li>
						<li>
							<span class="window_row_li"><font color="red">*</font>手机：</span>
							<input id="custPhone1" type="text" value="" name="custPhone" class="easyui-textbox" placeholder="对这个角色的描述" />
						</li>
					</ul>
				</div>
				<div class="window_row">
					<ul>
						<li>
							<span class="window_row_li"><font color="red">*</font>店铺名称：</span>
							<input id="shopName" type="text" value="" name="shopName" class="easyui-textbox" placeholder="对这个角色的描述" />
						</li>
						<li>
							<span class="window_row_li">店铺面积：</span> 
							<input id="acreAge" type="text" value="" name="acreAge" class="easyui-numberbox" placeholder="对这个角色的描述" />
						</li>
					</ul>
				</div>
				<div class="window_row window_row_address">
					<ul>
						<li>
							<span class="window_row_li"><font color="red">*</font>区域：</span>
						</li>
						<li>
							<div>
								<span> 省 <input class="easyui-textbox" id="province1"></span>
								<span style="float: right;"> 市 <input class="easyui-textbox" id="city1"></span>
							</div>
							<div>
								<span> 区 <input class="easyui-textbox" id="area1"></span>
								<span style="float: right;"> 镇 <input class="easyui-textbox" id="street1"></span>
							</div>
							<div>
								<span> 村 <input class="easyui-textbox" id="country1"></span>
							</div>
						</li>
					</ul>
				</div>
				<div class="window_row">
					<ul>
						<li>
							<span class="window_row_li"><font color="red">*</font>地址：</span>
							<input id="custAddress" type="text" value="" name="custAddress" class="easyui-textbox" placeholder="对这个角色的描述" />
						</li>
						<li>
							<span class="window_row_li"><font color="red">*</font>主营业务：</span>
							<input id="custMain" type="text" value="" name="custMain" class="easyui-textbox" placeholder="对这个角色的描述" />
						</li>
					</ul>
				</div>
				<div class="window_row window_row_select">
					<ul>
						<li>
							<span class="window_row_li"><font color="red">*</font>商户类型：</span>
							<input id="custType" class="easyui-combobox" />
						</li>
						<li>
							<span class="window_row_li"><font color="red">*</font>开业时间：</span>
							<input id="openTime" type="text" value="" name="openTime" class="easyui-combobox" placeholder="对这个角色的描述" />
						</li>
					</ul>
				</div>
				<div class="window_row window_row_select">
					<ul>
						<li>
							<span class="window_row_li"><font color="red">*</font>产权：</span>
							<input id="property" class="easyui-combobox" /></li>
						<li>
							<span class="window_row_li"><font color="red">*</font>手机类型：</span>
							<input id="phoneType" type="text" value="" name="phone_type" class="easyui-combobox" placeholder="对这个角色的描述" />
						</li>
					</ul>
				</div>
			</div>
		</form>
		<div id="allmap" style="margin: 10px auto;"></div>
		<div style="margin: 10px auto; text-align: center;">
			<a class="easyui-linkbutton window-submitBtn" onclick="submitSave()">提交</a>
		</div>
	</div>
	<div id="w2">
		<form action="creditRating.do" method="post" id="form2">
			<input type="hidden" name="areaId" id="areaId"> 
			<input type="hidden" name="custId" id="custId"> 
			<input type="hidden" id="map_x2" value=""> 
			<input type="hidden" id="map_y2" value="">
			<div class="window_content">
				<div class="window_row">
					<ul>
						<li>
							<span class="window_row_li"><font color="red">*</font>负责人姓名：</span>
							<input id="custName2" type="text" name="custName2" value="" class="easyui-textbox" placeholder="角色的名称" /> 
							<label id="custNamelabel" name="custNamelabel" class="label" value=""></label>
						</li>
						<li>
							<span class="window_row_li"><font color="red">*</font>手机号码：</span>
							<label id="custPhonelabel" name="custPhonelabel" class="label" value=""></label> 
							<input id="custPhone2" type="text" value="" name="custPhone2" class="easyui-textbox" placeholder="对这个角色的描述" />
						</li>
					</ul>
				</div>
				<div class="window_row">
					<ul>
						<li>
							<span class="window_row_li"><font color="red">*</font>店铺名称：</span>
							<label id="shopNamelabel" name="shopNamelabel" class="label" value=""></label> 
							<input id="shopName2" type="text" value="" name="shopName2" class="easyui-textbox" placeholder="对这个角色的描述" />
						</li>
						<li><span class="window_row_li">店铺面积：</span> <label
							id="acreAgelabel" name="acreAgelabel" class="label" value=""></label>
							<input id="acreAge2" type="text" value="" name="acreAge2"
							class="easyui-numberbox" placeholder="对这个角色的描述" /></li>
					</ul>
				</div>
				<div class="window_row window_row_address2">
					<ul>
						<li><span class="window_row_li"><font color="red">*</font>区域：</span>
						</li>
						<li>
							<div>
								<span id="area2"></span>
							</div>
							<div>
								<input id="street2" class="pro">
								<label id="streetlabel"class="label"></label> 
								<input id="country2" class="pro">
								<label id="countrylabel" name="countrylabel" class="label" value=""></label>
							</div>
						</li>
					</ul>
				</div>
				<div class="window_row">
					<ul>
						<li>
							<span class="window_row_li"><font color="red">*</font>状态：</span>
							<input id="custState" class="easyui-combobox"> 
							<label id="custStatelabel" class="label"></label>
						</li>
						<li>
							<span class="window_row_li"><font color="red">*</font>主营业务：</span>
							<label id="custMainlabel" class="label"></label> 
							<input id="custMain2" type="text" value="" name="custMain2" class="easyui-textbox" placeholder="对这个角色的描述" />
						</li>
					</ul>
				</div>
				<div class="window_row window_row_select">
					<ul>
						<li>
							<span class="window_row_li"><font color="red">*</font>商户类型：</span>
							<label id="custTypelabel" class="label"></label> 
							<input id="custType2" class="easyui-combobox">
						</li>
						<li>
							<span class="window_row_li"><font color="red">*</font>开业时间：</span>
							<label id="openTimelabel" class="label"></label> 
							<input id="openTime2" type="text" value="" name="openTime2" class="easyui-combobox" placeholder="对这个角色的描述" />
						</li>
					</ul>
				</div>
				<div class="window_row window_row_select">
					<ul>
						<li>
							<span class="window_row_li"><font color="red">*</font>产权：</span>
							<input id="property2" class="easyui-combobox"> 
							<label id="propertylabel" class="label"></label>
						</li>
						<li>
							<span class="window_row_li"><font color="red">*</font>手机类型：</span>
							<input id="phoneType2" type="text" value="" name="phone_type" class="easyui-combobox" placeholder="对这个角色的描述" /> 
							<label id="phoneTypelabel" class="label"></label>
						</li>
					</ul>
				</div>
				<div class="window_row">
					<ul>
						<li>
							<span class="window_row_li"><font color="red">*</font>地址：</span>
							<label id="custAddresslabel" name="custAddresslabel" class="label"></label> 
							<input id="custAddress2" type="text" value="" name="custAddress2" class="easyui-textbox" placeholder="对这个角色的描述" />
						</li>
					</ul>
				</div>
			</div>
			<div id="allmap2" style="margin: 10px auto;"></div>
			<div style="margin: 10px auto; text-align: center;">
				<div align="center" id="detailsDiv">
					<a id="updBtn" class="easyui-linkbutton window-submitBtn" onclick="update()" style="display:none;">编辑</a>
				</div>
				<div align="center" id="upDiv">
					<a id="subBtn" class="easyui-linkbutton window-submitBtn" onclick="submitSave2()">提交</a>
				</div>
			</div>
		</form>
	</div>
	<div id="mark">
		<form id="markfrom" action="" method="get" style="padding: 50px">
			<input type="hidden" name="custIds1">
			<table>
				<tr>
					<td align="right" width="100px;">
						<font color="red">*</font> 
						<span style="font-weight: 600;">标记:</span>
					</td>
					<td align="left" width="300px;">
						<label>
							<input name="markId" type="radio" value="1" />
							<img src="../../images/1.png">
						</label> 
						<label>
							<input name="markId" type="radio" value="2" />
							<img src="../../images/2.png"> 
						</label> 
						<label>
							<input name="markId" type="radio" value="3" />
							<img src="../../images/3.png"> 
						</label> 
						<label>
							<input name="markId" type="radio" value="4" />
							<img src="../../images/4.png"> 
						</label> 
						<label>
							<input name="markId" type="radio" value="5" />
							<img src="../../images/5.png"> 
						</label> 
						<label>
							<input name="markId" type="radio" value="6" />
							<img src="../../images/6.png"> 
						</label>
					</td>
				</tr>
				<tr>
					<td align="right" width="100px;">
						<font color="red">*</font> 
						<span style="font-weight: 600;">标记信息:</span>
					</td>
					<td align="left" width="300px;">
						<textarea name="reMark" style="width: 300px; height: 200px; max-width: 300px; max-height: 200px;"></textarea>
					</td>
				</tr>
				<tr>
					<td align="center" colspan="2">
						<div align="center">
							<a class="easyui-linkbutton" data-options="iconCls:'icon-save'" onclick="saveMark()">提交</a>
						</div>
					</td>
				</tr>
			</table>
		</form>
	</div>
	<div id="gsms">
		<form id="gsmsfrom" action="" method="post" style="padding: 20px 50px 30px 50px">
			<input type="hidden" id="toCust"> 
			<input type="hidden" id="toCustId">
			<table>
				<tr>
					<td align="right" width="100px;">
						<font color="red"></font> 
						<span style="font-weight: 600;">收信人:</span>
					</td>
					<td align="left" width="300px;">
						<span style="font-weight: 600;" id="toCustName"></span>
					</td>
				</tr>
				<tr>
					<td align="right" width="100px;">
						<font color="red">*</font> 
						<span style="font-weight: 600;">短信内容:</span>
					</td>
					<td align="left" width="300px;">
						<textarea id="smsContent" style="width: 300px; height: 200px; max-width: 300px; max-height: 200px;"></textarea>
						<div style="color: #afa5a5;">
							还可输入<span id="smsnum">62</span>个字
						</div>
					</td>
				</tr>
			</table>
			<div style="width:100%;text-align:center;padding:10px auto;">
				<a class="easyui-linkbutton window-submitBtn" onclick="doSendSms()">提交</a>
			</div>
		</form>
	</div>

	<div id="imgWin">
		<img id="img" src="" width="100%" height="100%">
	</div>
	<div id="opCustLaberSet" class="easyui-window" title="客户标签设置" style="width: 480px; height: 480px;"></div>
</body>
</html>